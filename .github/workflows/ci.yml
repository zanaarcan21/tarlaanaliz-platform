# BOUND: TARLAANALIZ_SSOT_v1_0_0.txt – canonical rules are referenced, not duplicated.
# PATH: .github/workflows/ci.yml
# DESC: KR-041 SDLC kapıları kapsamında temel CI doğrulamalarını çalıştırmak.

name: Backend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'alembic/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'alembic/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'

permissions:
  contents: read
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  lint:
    name: Lint & Format (Ruff)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check src/ tests/ alembic/ --select E9,F63,F7,F82

      - name: Run ruff format check (focused)
        run: ruff format --check tests/unit/test_calibration_gate.py

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports

  unit-tests:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run unit tests with coverage
        run: pytest tests/unit/ -m unit --cov=src --cov-report=xml --cov-report=term-missing -q || pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing -q --ignore=tests/integration --ignore=tests/e2e

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage.xml
          retention-days: 7

  migration-check:
    name: Migration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install alembic sqlalchemy

      - name: Validate migration chain
        run: |
          python -c "
          import os, sys
          # Alembic migration dosyalarinin varligini kontrol et
          migration_dir = 'alembic/versions'
          if not os.path.isdir(migration_dir):
              print('Migration directory not found')
              sys.exit(1)
          files = [f for f in os.listdir(migration_dir) if f.endswith('.py') and not f.startswith('__')]
          print(f'Found {len(files)} migration files')
          for f in sorted(files):
              print(f'  - {f}')
          "

  status-check:
    name: Backend CI Status
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-tests, migration-check]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Type Check: ${{ needs.type-check.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Migration Check: ${{ needs.migration-check.result }}"

          if [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.unit-tests.result }}" == "failure" ] || \
             [ "${{ needs.migration-check.result }}" == "failure" ]; then
            echo "Backend CI failed"
            exit 1
          fi
          echo "Backend CI passed"

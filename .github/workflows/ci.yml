# BOUND: TARLAANALIZ_SSOT_v1_0_0.txt – canonical rules are referenced, not duplicated.
# PATH: .github/workflows/ci.yml
# DESC: KR-041 SDLC kapıları kapsamında temel CI doğrulamalarını çalıştırmak.

name: Backend CI

on:
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "tests/**"
      - "alembic/**"
      - "pyproject.toml"
      - ".github/workflows/ci.yml"
      - ".github/pull_request_template.md"
      - "scripts/check_ssot_compliance.py"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "tests/**"
      - "alembic/**"
      - "pyproject.toml"
      - ".github/workflows/ci.yml"
      - ".github/pull_request_template.md"
      - "scripts/check_ssot_compliance.py"

permissions:
  contents: read
  pull-requests: write

env:
  PYTHON_VERSION: "3.12"

jobs:
  ssot-compliance:
    name: SSOT Compliance Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run SSOT compliance checks
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          fi

          python scripts/check_ssot_compliance.py --base "$BASE" --head "$HEAD"

  lint:
    name: Lint & Format (Ruff)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check src/ tests/ alembic/ --select E9,F63,F7,F82

      - name: Run ruff format check (focused)
        run: ruff format --check tests/unit/test_calibration_gate.py

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run mypy
        run: python -m mypy --config-file pyproject.toml src

  unit-tests:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Verify submodule checkout
        shell: bash
        run: |
          set -euo pipefail
          echo "Submodules (recursive):"
          git submodule status --recursive || true

          if [ -d "contracts" ]; then
            echo "contracts HEAD:"
            git -C contracts rev-parse HEAD || true
          else
            echo "contracts submodule not present (skipping submodule checks)."
          fi

      - name: Detect contracts schema changes
        id: contracts_filter
        shell: bash
        run: |
          set -euo pipefail

          # Eğer contracts submodule yoksa contracts testlerini pas geç
          if [ ! -d "contracts" ]; then
            echo "run_contracts_tests=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          fi

          echo "BASE=$BASE"
          echo "HEAD=$HEAD"

          changed="$(git diff --name-only "$BASE" "$HEAD" || true)"
          echo "$changed"

          # contracts altında bir değişiklik yoksa pas geç
          if ! echo "$changed" | grep -qE '^contracts/'; then
            echo "run_contracts_tests=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Submodule pointer değişimini yakala
          old_sha="$(git show "$BASE":.gitmodules >/dev/null 2>&1 && git ls-tree "$BASE" contracts | awk '{print $3}' || true)"
          new_sha="$(git ls-tree "$HEAD" contracts | awk '{print $3}' || true)"

          if [ -z "$old_sha" ] || [ -z "$new_sha" ]; then
            echo "run_contracts_tests=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "contracts old=$old_sha new=$new_sha"

          git -C contracts fetch --depth=50 origin "$old_sha" "$new_sha" || git -C contracts fetch origin "$old_sha" "$new_sha"

          if git -C contracts diff --name-only "$old_sha" "$new_sha" -- schemas/ | grep -q .; then
            echo "run_contracts_tests=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_contracts_tests=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run contracts tests (only if schemas changed)
        if: steps.contracts_filter.outputs.run_contracts_tests == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          python -m pip install pytest jsonschema
          python -m pip install -e ./contracts || true
          python -m pytest -q contracts/tests

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run unit tests with coverage
        run: |
          pytest tests/unit/ -m unit --cov=src --cov-report=xml --cov-report=term-missing -q || \
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing -q --ignore=tests/integration --ignore=tests/e2e

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage.xml
          retention-days: 7

  migration-check:
    name: Migration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install alembic sqlalchemy

      - name: Validate migration chain
        run: |
          python -c "
          import os, sys
          migration_dir = 'alembic/versions'
          if not os.path.isdir(migration_dir):
              print('Migration directory not found')
              sys.exit(1)
          files = [f for f in os.listdir(migration_dir) if f.endswith('.py') and not f.startswith('__')]
          print(f'Found {len(files)} migration files')
          for f in sorted(files):
              print(f'  - {f}')
          "

  status-check:
    name: Backend CI Status
    runs-on: ubuntu-latest
    needs: [ssot-compliance, lint, type-check, unit-tests, migration-check]
    if: always()

    steps:
      - name: Check all jobs
        shell: bash
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Type Check: ${{ needs.type-check.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Migration Check: ${{ needs.migration-check.result }}"
          echo "SSOT Compliance: ${{ needs.ssot-compliance.result }}"

          if [ "${{ needs.ssot-compliance.result }}" = "failure" ] || \
             [ "${{ needs.lint.result }}" = "failure" ] || \
             [ "${{ needs.type-check.result }}" = "failure" ] || \
             [ "${{ needs.unit-tests.result }}" = "failure" ] || \
             [ "${{ needs.migration-check.result }}" = "failure" ]; then
            echo "Backend CI failed"
            exit 1
          fi

          echo "Backend CI passed"
# =============================================================================
# TarlaAnaliz - Base Rate Limits Configuration
# =============================================================================
# SSOT Referans: TARLAANALIZ_SSOT_v2_6_0.md (KR-040, KR-050)
# Versiyon: v2.6.0
# 
# Bu dosya rol bazlı ve endpoint bazlı rate limiting kurallarını tanımlar.
# SSOT'daki güvenlik gereksinimlerine %100 uyumludur.
# =============================================================================

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global:
  enabled: true
  storage: redis  # Options: redis, memory (production: redis zorunlu)
  key_prefix: "ratelimit:"
  
  # Varsayılan limitler (rol/endpoint tanımı yoksa uygulanır)
  default:
    requests_per_minute: 60
    burst: 10
    window: 60  # saniye
  
  # IP bazlı global limit (DDoS koruması)
  per_ip:
    requests_per_minute: 300
    burst: 50
    window: 60
  
  # Lockout politikası
  lockout:
    enabled: true
    max_violations: 3  # 3 kez limit aşımında
    duration_minutes: 15  # 15 dakika ban

# -----------------------------------------------------------------------------
# Role-Based Limits (SSOT: KR-063 RBAC)
# -----------------------------------------------------------------------------
roles:
  # Çiftçi (Farmer)
  FARMER:
    requests_per_minute: 60
    burst: 10
    endpoints:
      # Auth endpoints (düşük limit - brute force koruması)
      "POST /api/v1/auth/login": 10
      "POST /api/v1/auth/verify-pin": 10
      "POST /api/v1/auth/refresh": 20
      
      # Field management
      "POST /api/v1/fields": 30
      "GET /api/v1/fields": 100
      "PUT /api/v1/fields/{field_id}": 30
      
      # Analysis requests
      "POST /api/v1/analysis/request": 20
      "GET /api/v1/analysis/results": 100
      
      # Profile
      "GET /api/v1/users/me": 60
      "PUT /api/v1/users/me": 20
  
  # Kooperatif Sahibi (Cooperative Owner)
  COOP_OWNER:
    requests_per_minute: 120
    burst: 20
    endpoints:
      "POST /api/v1/auth/login": 10
      "POST /api/v1/cooperative/members/invite": 50
      "POST /api/v1/cooperative/members/bulk-import": 10
      "GET /api/v1/cooperative/members": 200
      "POST /api/v1/fields": 60
      "POST /api/v1/analysis/request": 50
  
  # Kooperatif Admin
  COOP_ADMIN:
    requests_per_minute: 100
    burst: 15
    endpoints:
      "POST /api/v1/auth/login": 10
      "POST /api/v1/cooperative/members/invite": 40
      "GET /api/v1/cooperative/members": 150
      "POST /api/v1/fields": 50
      "POST /api/v1/analysis/request": 40
  
  # Kooperatif Agronomist (sadece görüntüleme)
  COOP_AGRONOMIST:
    requests_per_minute: 80
    burst: 15
    endpoints:
      "POST /api/v1/auth/login": 10
      "GET /api/v1/fields": 150
      "GET /api/v1/analysis/results": 200
      # POST endpoint'leri yok (read-only)
  
  # Kooperatif Viewer (sadece görüntüleme)
  COOP_VIEWER:
    requests_per_minute: 60
    burst: 10
    endpoints:
      "POST /api/v1/auth/login": 10
      "GET /api/v1/fields": 100
      "GET /api/v1/analysis/results": 150
      # POST endpoint'leri yok (read-only)
  
  # Drone Pilotu
  PILOT:
    requests_per_minute: 80
    burst: 15
    endpoints:
      "POST /api/v1/auth/login": 10
      "GET /api/v1/missions/assigned": 100
      "POST /api/v1/missions/{mission_id}/upload": 20
      "GET /api/v1/missions/{mission_id}/status": 100
      # Sonuç endpoint'lerine ERİŞEMEZ (SSOT: KR-015)
  
  # İl Operatörü (SSOT: KR-018 - PII görmez)
  PROVINCE_OPERATOR:
    requests_per_minute: 100
    burst: 20
    endpoints:
      "POST /api/v1/auth/login": 10
      "GET /api/v1/operator/dashboard": 100
      "GET /api/v1/operator/metrics": 150
      "GET /api/v1/operator/capacity": 100
      # PII endpoint'lerine ERİŞEMEZ
  
  # Expert (Uzman İnceleme - SSOT: KR-019)
  EXPERT:
    requests_per_minute: 120
    burst: 20
    endpoints:
      "POST /api/v1/auth/login": 10
      "GET /api/v1/expert/reviews/pending": 200
      "GET /api/v1/expert/reviews/{review_id}": 150
      "POST /api/v1/expert/reviews/{review_id}/verdict": 50
      "GET /api/v1/expert/dashboard": 100
      # WebSocket için ayrı limit (aşağıda)
  
  # Admin (Merkez Yönetim - KVKK/PII erişimi var)
  ADMIN:
    requests_per_minute: 300
    burst: 50
    endpoints:
      "POST /api/v1/auth/login": 10
      # Admin tüm endpoint'lere erişebilir
      # Rate limit yine uygulanır ama yüksek

# -----------------------------------------------------------------------------
# Endpoint-Based Limits (Rol bağımsız)
# -----------------------------------------------------------------------------
endpoints:
  # Auth endpoints (SSOT: KR-050 - Brute force koruması)
  "POST /api/v1/auth/login":
    requests_per_minute: 10
    burst: 3
    window: 60
    # 16 başarısız denemede 30 dakika lockout (kod seviyesinde implement edilir)
  
  "POST /api/v1/auth/register":
    requests_per_minute: 5
    burst: 2
    window: 60
  
  "POST /api/v1/auth/verify-pin":
    requests_per_minute: 10
    burst: 3
    window: 60
    # 16 başarısız PIN denemesinde lockout (SSOT: KR-050)
  
  "POST /api/v1/auth/refresh":
    requests_per_minute: 20
    burst: 5
    window: 60
  
  # SMS endpoints (maliyet kontrolü)
  "POST /api/v1/auth/send-pin":
    requests_per_minute: 3
    burst: 1
    window: 60
    per_phone_daily_limit: 5  # Aynı numaraya günlük max 5 SMS
  
  # File upload endpoints
  "POST /api/v1/missions/{mission_id}/upload":
    requests_per_minute: 10
    burst: 3
    window: 60
    max_file_size_mb: 500  # GeoTIFF için
  
  # Bulk operations (kooperatif toplu import)
  "POST /api/v1/cooperative/members/bulk-import":
    requests_per_minute: 5
    burst: 2
    window: 60
    max_records_per_request: 1000
  
  # Export operations (training data export)
  "POST /api/v1/training/export":
    requests_per_minute: 10
    burst: 3
    window: 60
    max_concurrent_exports: 3
  
  # Pricing updates (audit log zorunlu)
  "PUT /api/v1/admin/pricing":
    requests_per_minute: 5
    burst: 2
    window: 60
    require_audit_log: true
  
  # Health check (rate limit yok)
  "GET /health":
    enabled: false
  
  "GET /metrics":
    enabled: false  # Prometheus scraping için limit yok

# -----------------------------------------------------------------------------
# WebSocket Rate Limits (Expert Portal için)
# -----------------------------------------------------------------------------
websocket:
  # Connection limits
  connections:
    per_user: 3  # Bir kullanıcı max 3 WebSocket bağlantısı
    per_ip: 10   # Bir IP'den max 10 bağlantı
    global: 1000  # Toplam max 1000 aktif bağlantı
  
  # Message limits
  messages:
    per_connection_per_minute: 60
    burst: 10
  
  # Expert-specific
  expert:
    ping_interval_seconds: 30
    ping_timeout_seconds: 10
    max_pending_pings: 3

# -----------------------------------------------------------------------------
# Special Limits (Güvenlik ve İş Kuralları)
# -----------------------------------------------------------------------------
special:
  # PIN brute force koruması (SSOT: KR-050)
  pin_authentication:
    max_attempts: 16  # Değişmez (SSOT kuralı)
    lockout_duration_minutes: 30  # Değişmez (SSOT kuralı)
    reset_after_success: true
  
  # Tarla kaydı tekil kontrolü (SSOT: KR-013)
  field_registration:
    duplicate_check: true
    check_fields:
      - province_code
      - district
      - neighborhood
      - ada
      - parsel
  
  # Bitki türü değiştirme (SSOT: KR-013)
  crop_type_change:
    max_per_year: 1
    allowed_months: [10, 11, 12]  # Ekim, Kasım, Aralık
    # Backend validation zorunlu
  
  # Mission upload (drone pilot)
  mission_upload:
    require_drone_serial: true
    require_mission_id: true
    hash_verification: true  # SHA-256 manifest (SSOT: KR-017)
  
  # Expert review SLA (SSOT: KR-019)
  expert_review:
    sla_hours: 48
    escalation_hours: 4
    max_concurrent_reviews_per_expert: 10
  
  # Model extraction koruması (SSOT: güvenlik tablosu)
  model_access:
    max_requests_per_day: 50
    anomaly_threshold: 0.8
    throttle_on_anomaly: true

# -----------------------------------------------------------------------------
# Error Responses
# -----------------------------------------------------------------------------
error_responses:
  # HTTP 429 Too Many Requests
  rate_limit_exceeded:
    status_code: 429
    message: "Rate limit exceeded. Please try again later."
    headers:
      X-RateLimit-Limit: "{{limit}}"
      X-RateLimit-Remaining: "{{remaining}}"
      X-RateLimit-Reset: "{{reset_timestamp}}"
      Retry-After: "{{retry_after_seconds}}"
  
  # HTTP 403 Forbidden (Lockout)
  account_locked:
    status_code: 403
    message: "Account temporarily locked due to excessive failed attempts."
    retry_after_minutes: "{{lockout_duration}}"

# -----------------------------------------------------------------------------
# Monitoring & Alerting
# -----------------------------------------------------------------------------
monitoring:
  # Prometheus metrics
  metrics:
    enabled: true
    labels:
      - endpoint
      - role
      - user_id
      - ip_address
  
  # Alerting thresholds
  alerts:
    # Rate limit aşımı yüksek olduğunda
    high_violation_rate:
      threshold: 100  # 100 violation/minute
      severity: warning
    
    # Lockout sayısı yüksek olduğunda
    high_lockout_rate:
      threshold: 10  # 10 lockout/minute
      severity: critical
    
    # Brute force attack detected
    brute_force_detected:
      threshold: 50  # 50 failed login/minute
      severity: critical
  
  # Log settings
  logging:
    enabled: true
    log_violations: true
    log_lockouts: true
    structured_logs: true
    correlation_id: true

# -----------------------------------------------------------------------------
# Testing Overrides (Development/Testing ortamında)
# -----------------------------------------------------------------------------
testing:
  enabled: false  # Production'da false olmalı
  # Test ortamında limitler çok yüksek tutulur
  multiplier: 100  # Tüm limitler 100x artırılır
  disable_lockout: true

# =============================================================================
# NOTES
# =============================================================================
# 
# SSOT Uyumluluğu:
# ----------------
# - PIN_MAX_ATTEMPTS: 16 (KR-050, değişmez)
# - PIN_LOCKOUT_DURATION: 30 dakika (KR-050, değişmez)
# - Expert Review SLA: 48 saat (KR-019)
# - Escalation: 4 saat (KR-019)
# - Tarla kaydı tekil kontrolü (KR-013)
# - Bitki türü değişikliği: yılda 1, Ekim-Aralık (KR-013)
# 
# Güvenlik:
# ---------
# - Auth endpoint'lerde düşük limit (brute force koruması)
# - SMS endpoint'lerde çok düşük limit (maliyet kontrolü)
# - IP bazlı global limit (DDoS koruması)
# - WebSocket connection limit (DoS koruması)
# - Model extraction koruması (model çalınması riski)
# 
# Monitoring:
# -----------
# - Tüm rate limit aşımları loglanır
# - Prometheus metrikleri export edilir
# - Alert threshold'ları tanımlanmış
# - Correlation ID her zaman taşınır
# 
# Testing:
# --------
# - Test ortamında `testing.enabled: true` yapılabilir
# - Limitler 100x artırılır (test kolaylığı için)
# - Lockout devre dışı bırakılabilir
# - Production'da ASLA testing mode açılmamalı
# 
# =============================================================================

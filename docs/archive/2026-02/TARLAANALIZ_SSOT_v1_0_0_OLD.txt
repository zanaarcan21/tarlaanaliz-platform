# TarlaAnaliz â€“ Tek Kaynak GerÃ§ek (SSOT)
## Single Source of Truth v1.0.0

**SÃ¼rÃ¼m:** 1.0.0 | **Tarih:** 2026-02-08 | **Format:** AI-Ready Unified Document (SadeleÅŸtirilmiÅŸ)

**ðŸ§± v1.0.0 Baz SÃ¼rÃ¼m NotlarÄ± (Kod Ãœretimi BaÅŸlangÄ±cÄ±):**
- Bu dokÃ¼man, TarlaAnaliz iÃ§in **tek kanonik SSOT** olarak kabul edilir ve kod Ã¼retiminde â€œnormatif kaynakâ€tÄ±r.
- Kritik sabitler:
  - Kimlik: **telefon + 6 haneli PIN**, e-posta/TCKN yok, OTP/SMS doÄŸrulama yok â†’ **[KR-050]**
  - YZ izolasyonu ve tek yÃ¶nlÃ¼ sonuÃ§ akÄ±ÅŸÄ± â†’ **[KR-017]** (operasyonel Ã¶zet: **[KR-070]**, SOP: **BÃ–LÃœM 2.6**)
  - Tam radyometrik kalibrasyon â€œhard gateâ€ â†’ **[KR-018 / KR-082]**
  - Contract-first (makine-doÄŸrulanabilir ÅŸema) â†’ **[KR-081]**
  - Ã–deme + manuel onay akÄ±ÅŸÄ± â†’ **[KR-033]**
  - RBAC kanonik matrisi â†’ **[KR-063]** (Ã¶zet rol anlatÄ±mÄ±: **[KR-011]**)

# BÃ–LÃœM 1: KANONÄ°K KURALLAR [KR-xxx]

> âš ï¸ **KRÄ°TÄ°K:** Bu bÃ¶lÃ¼mdeki kurallar deÄŸiÅŸtirilemez. TÃ¼m kod bu kurallara uymalÄ±dÄ±r.

## [KR-000] Bu dokÃ¼man seti nasÄ±l okunur?

- Saha adÄ±mlarÄ± ve DJI entegrasyon ayrÄ±ntÄ±larÄ± ayrÄ± bir SOP dokÃ¼manÄ±nda tutulur
- GeliÅŸtirici promptlarÄ±, API ve test/acceptance ÅŸablonlarÄ± ayrÄ± bir geliÅŸtirici paketinde tutulur
- Kimlik modeli: **bkz. [KR-050]** (normatif tek referans)
- DokÃ¼man dilinde 'kapsama-izi' terimi kullanÄ±lÄ±r. Sistem/API tarafÄ±nda aynÄ± kavram teknik olarak 'footprint' (observed footprint) olarak geÃ§ebilir; ikisi eÅŸ anlamlÄ±dÄ±r
- Bu dokÃ¼manda kanonik (normatif) kurallar, bÃ¶lÃ¼m baÅŸlÄ±klarÄ±nÄ±n baÅŸÄ±nda [KR-xxx] etiketi ile tanÄ±mlanÄ±r
- SÃ¼rÃ¼mleme politikasÄ±: Bu SSOT **SemVer** ile sÃ¼rÃ¼mlenir (1.0.0 baÅŸlangÄ±Ã§). DeÄŸiÅŸiklikler iÃ§in CHANGELOG tutulur; **breaking change â†’ major**, geriye uyumlu ekleme â†’ minor, yazÄ±m/dÃ¼zeltme â†’ patch.

---

## [KR-001] Proje Ã–zeti

**AmaÃ§:** Ã‡iftÃ§ilerin Ã¼rÃ¼n kaybÄ±nÄ± erken uyarÄ± ile azaltmak ve dÃ¶nÃ¼m bazlÄ± analiz hizmeti satmak. BaÅŸlangÄ±Ã§ bÃ¶lgesi GAP, ardÄ±ndan TÃ¼rkiye geneline Ã¶lÃ§ekleme.

**Sabit Ã‡erÃ§eve (DeÄŸiÅŸmez):**
- Drone: DJI Mavic 3M
- Veri: RGB + multispektral (NDVI/NDRE)
- YZ sadece analiz yapar; ilaÃ§lama/gÃ¼breleme kararÄ± **VERMEZ**
- SonuÃ§lar web (PWA) uygulamasÄ±nda harita Ã¼zerinde renk + desen/ikon ile gÃ¶sterilir

---

## [KR-002] Harita KatmanÄ± AnlamlarÄ± (Renk + Desen)

| Katman | Renk | Desen |
|--------|------|-------|
| SaÄŸlÄ±k (Health) | YeÅŸil | - |
| HastalÄ±k (Disease) | Turuncu | - |
| ZararlÄ± BÃ¶cek (Pest) | KÄ±rmÄ±zÄ± | - |
| Mantar (Fungus) | Mor | - |
| YabancÄ± Ot (Weed) | SarÄ±/Hardal | NoktalÄ± desen |
| Su Stresi | Mavi | Damla noktalÄ± desen |
| Azot Stresi | Soluk gri | Ã‡apraz Ã§izgili desen |

---

## [KR-010] Web (PWA) - Genel

## [KR-011] KullanÄ±cÄ± Rolleri ve Temel YaklaÅŸÄ±m

> **Not:** DetaylÄ± rol kodlarÄ± + yetki matrisi (RBAC) kanonik olarak **[KR-063]**'tedir. Bu bÃ¶lÃ¼m sadece Ã¶zet gÃ¶rÃ¼nÃ¼m saÄŸlar.

| Rol | Sorumluluk |
|-----|------------|
| Ã‡iftÃ§i | Kendi tarlalarÄ±nÄ± kaydeder, bitki tÃ¼rlerini tanÄ±mlar, analiz talebi oluÅŸturur, sonuÃ§larÄ± gÃ¶rÃ¼r |
| Kooperatif/Ãœreticiler BirliÄŸi | Kurumsal hesapla Ã¼ye olur; Ã¼ye Ã§iftÃ§ileri davet eder/aktarÄ±r; yetkisine gÃ¶re tarlalarÄ± yÃ¶netir ve analiz talebi aÃ§abilir |
| Drone Pilotu | Sadece DJI Mavic 3M ile uÃ§uÅŸ yapar; gÃ¶rÃ¼ntÃ¼leri her gÃ¼n hafÄ±za kartÄ±yla yerel istasyona aktarÄ±r; **sonuÃ§ raporunu GÃ–RMEZ** |
| Ä°l OperatÃ¶rÃ¼ (temsilci) | **PII gÃ¶rmeden** ticari KPI + kapasite planlama metriklerini izler; sÃ¶zleÅŸmeye gÃ¶re gelir payÄ± alÄ±r |
| Merkez YÃ¶netim | KVKK/PII eriÅŸimi olan tek yetkili katman; kullanÄ±cÄ±/kooperatif doÄŸrulama ve sistem politikalarÄ±nÄ± yÃ¶netir |

---

## [KR-012] Ä°ÅŸ PlanlamasÄ±

## [KR-013] Ã‡iftÃ§i ÃœyeliÄŸi ve Tarla YÃ¶netimi

**Ãœyelik:** PWA veya web Ã¼zerinden Ã¼ye olunur. Ä°l, ilÃ§e, ad, soyad ve telefon numarasÄ± alÄ±nÄ±r; Ã¼ye olunca kendi sayfasÄ±na yÃ¶nlendirilir.

**Tarla KaydÄ±:** Her tarla iÃ§in il, ilÃ§e, mahalle/kÃ¶y, ada, parsel ve alan (mÂ²) girilir. Sistem benzersiz FieldID Ã¼retir.

**Tekil KayÄ±t KuralÄ±:**
```
AynÄ± il + ilÃ§e + mahalle/kÃ¶y + ada + parsel kombinasyonu 
ikinci kez kaydedilemez.
```

**Bitki TÃ¼rÃ¼ TanÄ±mÄ±:** Her tarla iÃ§in ekili bitki tÃ¼rÃ¼ seÃ§ilir. Birden fazla bitki varsa her biri ayrÄ± seÃ§ilir ve alan (mÂ²) girilir.

**Analiz Talebi:** Bitki tÃ¼rÃ¼ bazÄ±nda oluÅŸturulur. SeÃ§enekler: yÄ±llÄ±k abonelik veya tek seferlik analiz.

**Bitki TÃ¼rÃ¼ DeÄŸiÅŸtirme KuralÄ±:**
```
YÄ±lda yalnÄ±zca 1 defa deÄŸiÅŸtirilebilir.
Sadece 1 Ekim - 31 AralÄ±k aralÄ±ÄŸÄ±nda.
Tarih dÄ±ÅŸÄ±nda deÄŸiÅŸiklik backend tarafÄ±ndan ENGELLENÄ°R.
```

---

## [KR-014] Kooperatif/Ãœretici BirliÄŸi ÃœyeliÄŸi ve Ä°ÅŸleyiÅŸ

**DoÄŸrulama:** Hesap 'Onay Bekliyor' aÃ§Ä±lÄ±r. Evrak kontrolÃ¼ sonrasÄ± Merkez yÃ¶netim 'Aktif' yapar; eksik evrak varsa aktif edilemez.

**Ãœye Ã‡iftÃ§i Dahil Etme:**
- (a) Davet (QR / 6 haneli davet kodu)
- (b) Toplu iÃ§e aktarÄ±m (Excel/CSV)
- Ã‡iftÃ§i kooperatif baÄŸlantÄ±sÄ±nÄ± kendi hesabÄ±ndan onaylar

**Tarla ve Analiz:** Tarla benzersizliÄŸi aynÄ±dÄ±r. Kooperatif yetkisine gÃ¶re Ã¼yeleri adÄ±na analiz talebi aÃ§abilir. "Tarla kaydÄ± tekil, sahiplik/eriÅŸim ayrÄ±" yaklaÅŸÄ±mÄ± uygulanÄ±r.

**Yetki Matrisi:**
- COOP_OWNER
- COOP_ADMIN
- COOP_AGRONOMIST (aksiyon kararÄ± vermez)
- COOP_VIEWER

---

## [KR-015] Drone PilotlarÄ± (DJI Mavic 3M ile UÃ§uÅŸ)

**Ãœyelik/KayÄ±t:** Ä°l, ilÃ§e, ad soyad, telefon; drone modeli ve seri numarasÄ±; hizmet verdiÄŸi mahalle/kÃ¶y listesi (baÅŸlangÄ±Ã§ta opsiyonel). Drone seri numarasÄ± doÄŸrulama referansÄ±dÄ±r.

**GÃ¼nlÃ¼k Veri Teslimi:** UÃ§uÅŸ Ã§Ä±ktÄ±sÄ± her gÃ¼n hafÄ±za kartÄ± ile yerel istasyona aktarÄ±lÄ±r. **Her uÃ§uÅŸta farklÄ± hafÄ±za kartÄ± kullanÄ±lÄ±r.**

> **Not:** DJI tarafÄ±ndaki kart kilidi/ÅŸifre/PIN gibi Ã¶zellikler cihaz ve sÃ¼rÃ¼me gÃ¶re deÄŸiÅŸebilir; gÃ¼venlik garantisi olarak deÄŸil, **sadece ek katman** olarak deÄŸerlendirilir.

**Her AktarÄ±m Log Ãœretir:** pilot kimliÄŸi, drone seri no, tarih/saat, batch id, tarla eÅŸleÅŸtirme durumu.

**EÅŸleÅŸtirme Zorunlu:** YÃ¼ke gelen veri seti mutlaka kayÄ±tlÄ± bir tarla ile otomatik eÅŸleÅŸir; minimum: il, ilÃ§e, mahalle/kÃ¶y, ada, parsel, bitki tÃ¼rÃ¼ (varsa FieldID). **EÅŸleÅŸtirme yoksa iÅŸlenmez.**

[KR-015-1] Pilot Ã‡alÄ±ÅŸma GÃ¼nleri ve GÃ¼nlÃ¼k Kapasite TanÄ±mÄ±

AmaÃ§: PilotlarÄ±n Ã§alÄ±ÅŸacaÄŸÄ± gÃ¼nleri seÃ§ebilmesi ve sistemin planlama motoruna net kapasite kÄ±sÄ±tlarÄ± saÄŸlamasÄ±.

[ZORUNLU] Pilot, haftalÄ±k Ã§alÄ±ÅŸma gÃ¼nlerini work_days olarak seÃ§er (Pztâ€“Paz kÃ¼mesi).

[ZORUNLU] |work_days| â‰¤ 6 (pilot en fazla 6 gÃ¼n Ã§alÄ±ÅŸabilir).

[ZORUNLU] Pilot iÃ§in daily_capacity_donum aralÄ±ÄŸÄ±: 2500â€“3000 dÃ¶nÃ¼m/gÃ¼n.

[ZORUNLU] VarsayÄ±lan kapasite (atanmamÄ±ÅŸsa): 2750 dÃ¶nÃ¼m/gÃ¼n.
[ZORUNLU] Bitki tÃ¼rÃ¼ bazlÄ± kapasite profili (CropOpsProfile): admin, her CropType iÃ§in daily_capacity_donum (varsayÄ±lan 2750; Ã¶nerilen aralÄ±k 2500â€“3000) ve SYSTEM_SEED_QUOTA (varsayÄ±lan 1500) deÄŸerlerini tanÄ±mlar; planlama motoru Mission.crop_type profiline gÃ¶re kota/kapasite uygular.

[ZORUNLU] Kapasite aÅŸÄ±m toleransÄ± yalnÄ±zca â€œacil durumâ€ iÃ§in %10 olabilir; Ã¼st sÄ±nÄ±r: daily_capacity_donum Ã— 1.10.

[OPSÄ°YONEL] Pilot, sezon yoÄŸunluÄŸuna gÃ¶re kapasiteyi â€œgelecek hafta geÃ§erli olacak ÅŸekildeâ€ gÃ¼ncelleyebilir (anlÄ±k deÄŸiÅŸiklik yok; operasyon stabilitesi).

[KR-015-2] Seed + Pull Ä°ÅŸ DaÄŸÄ±tÄ±m PolitikasÄ± (Sistem Verir + Pilot/Ã‡iftÃ§i SeÃ§imi)

AmaÃ§: Ä°lk iÅŸlerin sistem tarafÄ±ndan garanti edilmesi; kalan kapasitenin ise Ã§iftÃ§inin pilot seÃ§imi / pilotun mÃ¼ÅŸteri bulmasÄ±yla dolmasÄ±.

[ZORUNLU] Her pilot iÃ§in gÃ¼nlÃ¼k kapasite iki kotaya bÃ¶lÃ¼nÃ¼r:

SYSTEM_SEED_QUOTA: gÃ¼nlÃ¼k kapasitenin â€œsistem tarafÄ±ndan verilenâ€ kÄ±smÄ±

PULL_QUOTA: kalan kapasite (Ã§iftÃ§i seÃ§imi / pilot getirdiÄŸi iÅŸ)

[ZORUNLU] SYSTEM_SEED_QUOTA varsayÄ±lan: 1500 dÃ¶nÃ¼m/gÃ¼n.

[ZORUNLU] PULL_QUOTA varsayÄ±lan: daily_capacity_donum - 1500.

[ZORUNLU] SYSTEM_SEED gÃ¶revleri:

sistem otomatik atar (yakÄ±nlÄ±k + bÃ¶lge/territory + SLA + gÃ¼venilirlik)

pilot bu kotayÄ± reddedemez (sÃ¶zleÅŸme/operasyon gereÄŸi)

[ZORUNLU] PULL gÃ¶revleri:

Ã§iftÃ§i â€œuygun pilot listesiâ€nden seÃ§im yapabilir ve/veya pilot kendi getirdiÄŸi iÅŸi sisteme baÄŸlayabilir

kapasite uygunsa pilota â€œkabul/retâ€ hakkÄ± tanÄ±nabilir (operasyonel esneklik)

[ZORUNLU] Pilot, Ã§iftÃ§i PII gÃ¶rmeden Ã§alÄ±ÅŸÄ±r; gÃ¶revler MissionID + Field/ParcelRef + konum dÃ¼zeyinde sunulur.

[KR-015-3] Pilot Ä°ptal / Uygun DeÄŸilim Bildirimi ve Otomatik Yeniden Atama

AmaÃ§: Pilot gÃ¶rev yapamayacaksa zamanÄ±nda bildirsin; sistem gÃ¶revi baÅŸka pilota aktarsÄ±n.

[ZORUNLU] Pilot, kendisine atanmÄ±ÅŸ gÃ¼nlÃ¼k/haftalÄ±k iÅŸi yapamayacaksa en az 12 saat Ã¶nce bildirim yapmalÄ±dÄ±r.

[OPSÄ°YONEL] Ã–nerilen bildirim sÃ¼resi: 24 saat.

[ZORUNLU] Bildirim geldiÄŸinde:

gÃ¶rev â€œyeniden atama kuyruÄŸuâ€na alÄ±nÄ±r

sistem alternatif pilot atar

eski/yeni pilota bildirim gÃ¶nderilir (uygulama iÃ§i)

[ZORUNLU] Bildirimsiz â€œno-showâ€ durumlarÄ± pilot gÃ¼venilirlik skorunu dÃ¼ÅŸÃ¼rÃ¼r ve admin inceleme sÃ¼recini tetikleyebilir.

[ZORUNLU] TÃ¼m iptal ve yeniden atamalar audit logâ€™a yazÄ±lÄ±r:

actor (pilot/admin)

timestamp

reason

eski/yeni pilot

etkilenen mission(lar)

[KR-015-4] Admin Atama DeÄŸiÅŸikliÄŸi ve Otomatik Yeniden Dengeleme

AmaÃ§: Sistem otomatik atar; admin gerekirse deÄŸiÅŸtirir; sistem Ã§akÄ±ÅŸmalarÄ± otomatik toparlar.

[ZORUNLU] Sistem pilot atamasÄ±nÄ± otomatik yapar (Auto-Dispatcher).

[ZORUNLU] Admin, herhangi bir Mission iÃ§in pilot atamasÄ±nÄ± deÄŸiÅŸtirebilir (override).

[ZORUNLU] Admin override zorunlu alanlarÄ±:

new_pilot_id

override_reason (boÅŸ olamaz)

admin_id (audit)

[ZORUNLU] Override sonrasÄ± sistem:

sadece â€œetkilenen gÃ¼n/pencereâ€ iÃ§in planÄ± yeniden dengeler (kapasite Ã§akÄ±ÅŸmasÄ±, SLA riski)

adminâ€™in seÃ§tiÄŸi pilotu â€œgeri almaâ€ yoluyla otomatik bozmaz; sadece diÄŸer gÃ¶revleri ayarlar.

[KR-015-5] Sezonluk Abonelikte Tarama Takvimi, GÃ¶rÃ¼nÃ¼rlÃ¼k ve SÄ±nÄ±rlÄ± GÃ¼n DeÄŸiÅŸtirme

AmaÃ§: Ã‡iftÃ§i sezon baÅŸÄ±nda tarih aralÄ±ÄŸÄ± + sÄ±klÄ±k seÃ§er; tÃ¼m sezon tarama gÃ¼nlerini gÃ¶rÃ¼r; sezonda 2â€“3 kez gÃ¼n kaydÄ±rabilir; pilot onayÄ± gerekir.

[ZORUNLU] â€œYÄ±llÄ±k abonelikâ€ terminolojisi UIâ€™da ve Ã¼rÃ¼n dilinde â€œSezonluk Paketâ€ olarak adlandÄ±rÄ±lÄ±r. (KR-027 uyarlanÄ±r.) 


[ZORUNLU] Sezonluk paket seÃ§erken Ã§iftÃ§i:

start_date, end_date

interval_days (Ã¶rn. pamuk: 7)

toplam analiz sayÄ±sÄ± (N) ve toplam fiyatÄ± (snapshot Ã¼zerinden) gÃ¶rÃ¼r

[ZORUNLU] Ã‡iftÃ§i ekranÄ±nda tÃ¼m sezon iÃ§in â€œplanlanan tarama gÃ¼nleriâ€ takvim gÃ¶rÃ¼nÃ¼mÃ¼nde gÃ¶sterilir (computed schedule).

[ZORUNLU] Sezonda sÄ±nÄ±rlÄ± gÃ¼n deÄŸiÅŸtirme hakkÄ±:

reschedule_tokens_per_season: varsayÄ±lan 2 (opsiyonel 3)
- Hava engeli (Weather Block) / force majeure nedeniyle yapÄ±lan ertelemeler **reschedule token tÃ¼ketmez**; sistem otomatik yeniden planlar ve audit logâ€™a yazar.

her token, planlÄ± bir tarama gÃ¼nÃ¼nÃ¼ â€œpencere iÃ§indeâ€ baÅŸka bir gÃ¼ne kaydÄ±rma talebidir

[ZORUNLU] GÃ¼n deÄŸiÅŸtirme akÄ±ÅŸÄ±:

Ã§iftÃ§i â€œyeni gÃ¼n Ã¶nerirâ€

sistem kapasite/SLA uygunluÄŸuna gÃ¶re alternatif slot/pilot Ã¶nerir

ilgili pilot(lar)a bildirim gider

pilot onaylarsa yeni gÃ¼n kesinleÅŸir; onaylamazsa eski plan korunur

[ZORUNLU] GÃ¼n deÄŸiÅŸtirme, audit logâ€™a â€œkim, neyi, ne zaman deÄŸiÅŸtirdiâ€ ÅŸeklinde yazÄ±lÄ±r.

[KR-015-6] BÃ¼yÃ¼k Alanlarda Ã‡oklu Pilot Planlama (Pencere BazlÄ± BÃ¶lme)

AmaÃ§: BÃ¼yÃ¼k alanlarda (Ã¶rn. 10.000 dÃ¶nÃ¼m) 7 gÃ¼nlÃ¼k pencere iÃ§inde birden fazla pilotla tarama yapÄ±labilsin.

[ZORUNLU] Sistem, sezonluk abonelikte her interval_days penceresi iÃ§in â€œhedef tarama tamamlanmaâ€ kuralÄ± uygular.

[OPSÄ°YONEL] BÃ¼yÃ¼k alan eÅŸiÄŸi aÅŸÄ±ldÄ±ÄŸÄ±nda sistem, pencereyi â€œiÅŸ paketlerineâ€ bÃ¶lebilir:

aynÄ± pencere iÃ§inde 2â€“N pilot atanabilir

her paket baÄŸÄ±msÄ±z uÃ§uÅŸ/upload kanÄ±tÄ± Ã¼retir

[ZORUNLU] Ã‡oklu pilot atamalarÄ±nda denetlenebilirlik:

her pilot katkÄ±sÄ± ayrÄ± kanÄ±t (flown/uploaded) Ã¼retir

sonuÃ§ raporu tek sezonsal zaman serisine birleÅŸir
---

## [KR-016] Drone - Tarla - Bitki EÅŸleÅŸtirme PolitikasÄ± (Routing)

**AmaÃ§:** Veri setini doÄŸru FieldID ve o tarihte geÃ§erli bitki tÃ¼rÃ¼ ile eÅŸleÅŸtirip doÄŸru bitki-Ã¶zel YZ modelini otomatik seÃ§mek.

**Tarla SÄ±nÄ±rÄ±:** Ada/parsel girilir; TKGM/MEGSIS ile parsel geometrisi alÄ±narak field boundary saklanÄ±r.

**UÃ§uÅŸ GÃ¶revi:** Field boundary Ã¼zerinden gÃ¶rev dosyasÄ± Ã¼retilir (KML/KMZ/WPML). Pilot DJI Pilot 2 ile iÃ§e aktarÄ±p standard mapping gÃ¶revini baÅŸlatÄ±r.

**GÃ¶rev DosyasÄ± AdlandÄ±rma StandardÄ±:**
```
{MissionID}_{ParcelRef}_{YYYYMMDD}.kmz
```
(Dosya adÄ±nda PII bulunmaz; MissionID dosya adÄ±nda ve metadata iÃ§inde yer alÄ±r)

**Ä°ÅŸlenmiÅŸ Ã‡Ä±ktÄ±lar:** DJI Terra (Agriculture Module) veya Pix4Dfields ile Ã¼retilen GeoTIFF standart kabul edilir.

**YÃ¼kleme AnÄ±:** Ä°stasyon batch metadata'dan Drone Seri No + MissionID (varsa) + kapsama-izi/footprint alanÄ±nÄ± alÄ±r. **Ã–ncelik MissionID; yoksa kapsama-izi-boundary kesiÅŸimi.**

**Bitki TÃ¼rÃ¼:** FieldID iÃ§in sezon bitkisi kaydÄ± esas (1 Ekim - 31 AralÄ±k aralÄ±ÄŸÄ±nda gÃ¼ncellenebilir).

---

## [KR-017] YZ Modeli ile Analiz (Kanonik: Ä°zolasyon + Tek YÃ¶nlÃ¼ AkÄ±ÅŸ + Job SemantiÄŸi)

[ZORUNLU]
- AnalysisJob aÃ§Ä±lÄ±rken kimlik: **FieldID + CropType + MissionID (varsa)**; **PII taÅŸÄ±nmaz**
- Bitkiye Ã¶zel YZ modeli routing (yÃ¶nlendirme) ile otomatik seÃ§ilir. Bu karar; **MissionID, FieldID ve bitki tÃ¼rÃ¼** ile kayÄ±t altÄ±na alÄ±nÄ±r (model_id / model_version).
- Pilot tarafÄ±nda gÃ¶rÃ¼nen gÃ¶rev bilgisi: **MissionID, il/ilÃ§e/mahalle-kÃ¶y, ada/parsel (ParcelRef), bitki tÃ¼rÃ¼, hedef tarama penceresi, teslim son tarihi**. **Ã‡iftÃ§i adÄ±/telefonu gÃ¶sterilmez**
- HafÄ±za kartlarÄ± yerel istasyonda gÃ¼venlik kontrollerinden (hash manifest, virÃ¼s tarama, allowlist uzantÄ±lar, karantina) geÃ§meden analize girmez
- EdgeKiosk/istasyon tarafÄ±nda **model Ã§alÄ±ÅŸtÄ±rma yoktur** (model hÄ±rsÄ±zlÄ±ÄŸÄ± riskine karÅŸÄ±)
- Worker (YZ/processing) **inbound istek kabul etmez**; job yalnÄ±zca dispatch/queue ile alÄ±nÄ±r. Web (PWA) ve public backend Worker aÄŸÄ±na **doÄŸrudan eriÅŸemez** (inbound kapalÄ±)
- Worker, **[KR-018 / KR-082]** kalibrasyon â€œhard gateâ€ ÅŸartÄ± saÄŸlanmadan iÅŸi kabul etmez (`requires_calibrated=true`)
- SonuÃ§lar **kesinlikle tek yÃ¶nlÃ¼** yayÄ±mlanÄ±r: **FieldID + CropType + katmanlar + skor/uyarÄ±** â†’ sonuÃ§ servisi â†’ web (PWA)
- EriÅŸim denemeleri/deny olaylarÄ± ve kritik adÄ±mlar audit/WORM logâ€™a dÃ¼ÅŸer (bkz. **BÃ–LÃœM 3**)

**Ä°lgili maddeler:** [KR-016], [KR-018 / KR-082], [KR-063], [KR-066], [KR-040-043], EK-SOP-SEC, BÃ–LÃœM 3, BÃ–LÃœM 4

---
## [KR-018 / KR-082] RADIOMETRY - Tam Radyometrik Kalibrasyon ZorunluluÄŸu (Radiometric Calibration: Ä±ÅŸÄ±k/sensÃ¶r etkilerini dÃ¼zeltme)

## AmaÃ§
- Model eÄŸitimi (training: modelin Ã¶ÄŸrenmesi) ve saha sonuÃ§larÄ± arasÄ±nda tutarlÄ±lÄ±k (training-serving parity: eÄŸitim/Ã§alÄ±ÅŸtÄ±rma aynÄ± daÄŸÄ±lÄ±m).
- MÃ¼ÅŸteri memnuniyeti iÃ§in zaman serisi (time-series: haftalÄ±k takip) ve tarlalar arasÄ± kÄ±yasÄ±n (cross-field comparison: farklÄ± tarlalarÄ± karÅŸÄ±laÅŸtÄ±rma) gÃ¼venilir olmasÄ±.

## Kural (Hard Gate: sert kapÄ±)
- **Calibrated Dataset (kalibre veri seti)** Ã¼retilmeden **AnalysisJob (analiz iÅŸi)** baÅŸlatÄ±lamaz.
- Worker (AI/Processing: yapay zekÃ¢ iÅŸleyici) **ham DN (Digital Number: sensÃ¶r ham sayÄ±sal deÄŸeri)** veya kalibrasyonu belirsiz veriyi kabul etmez.

## Ä°stasyon AkÄ±ÅŸÄ± (Real-world: saha ÅŸartlarÄ±na uygun)
1) **Offline Security PC (internetsiz gÃ¼venlik makinesi)**:
   - AV (Anti-Virus: zararlÄ± yazÄ±lÄ±m taramasÄ±) + manifest/hash (bÃ¼tÃ¼nlÃ¼k kanÄ±tÄ±) + quarantine (karantina: izolasyon)
2) **Online Producer Workstation (izole internetli kalibrasyon makinesi)**:
   - Producer (DJI Terra / Pix4Dfields vb.) ile **tam radyometrik kalibrasyon**
   - Reflectance Panel (yansÄ±ma paneli: Ä±ÅŸÄ±ÄŸÄ± bilinen hedef) kullanÄ±mÄ± SOPâ€™a (Standard Operating Procedure: standart iÅŸ akÄ±ÅŸÄ±) gÃ¶re zorunlu
   - Processing Report (iÅŸleme raporu) + Calibration Result (kalibrasyon Ã§Ä±ktÄ±sÄ±) + QC Report (Quality Control: kalite raporu)
3) **Dispatch/Upload (gÃ¶nderim)**:
   - Calibrated Dataset + raporlar + manifest/hash â†’ Workerâ€™a gÃ¶nder

## Platform SorumluluÄŸu (Backend: sunucu)
- Calibration Gate (kalibrasyon kapÄ±sÄ±): calibrated yoksa job aÃ§ma
- QC Gate (kalite kapÄ±sÄ±): PASS/WARN/FAIL (geÃ§/uyarÄ±/kal) kararÄ±nÄ± sakla, UIâ€™a taÅŸÄ±, audit trail (denetim izi) Ã¼ret

## Ã‡Ä±ktÄ± SÃ¶zleÅŸmeleri (Contracts: ortak veri ÅŸemalarÄ±)
- CalibrationJob / CalibrationResult
- QCReport (pass_warn_fail + flags + recommended_action)
- AnalysisJob yalnÄ±zca `requires_calibrated=true` ile aÃ§Ä±lÄ±r

## [KR-083] Ä°l OperatÃ¶rÃ¼

**Rol Kodu:** ProvinceOperator
**Gelir PayÄ±:** SÃ¶zleÅŸmeye gÃ¶re %5-%15 kar payÄ± alÄ±r (admin panelden tanÄ±mlanÄ±r).

**Ä°htiyaÃ§:** KPI + kapasite planlama (abonelik sayÄ±sÄ±, hizmet verilen alan, Ã¶deme toplamÄ±, ilÃ§e yoÄŸunluÄŸu, SLA).

**PII KuralÄ±:** Ä°l OperatÃ¶rÃ¼ **PII GÃ–RMEZ**.

**Sunum Ä°ki KatmanlÄ±:**
- (A) Merkez - PII ayrÄ±
- (B) OperatÃ¶r - SubscriberRef + ilÃ§e veya 1-2 km grid

---

## [KR-019] Expert Portal (Uzman Ä°nceleme)

- Uzman portalÄ±, modelin dÃ¼ÅŸÃ¼k gÃ¼ven verdiÄŸi veya Ã§eliÅŸkili durumlarda manuel inceleme iÃ§in kullanÄ±lÄ±r (**PII gÃ¶rÃ¼nmez**)
- Ãœyelik self-signup **deÄŸildir**: uzman hesabÄ± ADMIN kontrollÃ¼ aÃ§Ä±lÄ±r (curated onboarding)
- Bildirim kanallarÄ±: **SMS + web portal iÃ§i gerÃ§ek zamanlÄ± bildirim (WebSocket)**; e-posta kullanÄ±lmaz
- EriÅŸim kuralÄ±: uzman **yalnÄ±zca kendisine atanmÄ±ÅŸ** incelemeleri gÃ¶rÃ¼r (ownership check zorunlu)
- Uzman karar formatÄ± (Ã¶zet): `confirmed | corrected | rejected | needs_more_expert`
- Uzman geri bildirimi `training_grade` ile etiketlenir: `enum A|B|C|D|REJECT`; ayrÄ±ca `grade_reason` alanÄ± tutulur (max 200 karakter)

---

## [KR-020] Ãœcretlendirme

## [KR-021] Genel Prensip

- Ãœcretler bitki tÃ¼rÃ¼ ve analiz seÃ§eneÄŸine gÃ¶re: tek seferlik analiz veya yÄ±llÄ±k abonelik
- Birim: **dÃ¶nÃ¼m**. KullanÄ±cÄ± mÂ² girse bile sistem dÃ¶nÃ¼me Ã§evirip hesaplar
- YÄ±llÄ±k abonelikte periyot seÃ§ilebilir; sistem bitkiye gÃ¶re Ã¶nerir. Ã–neri dÄ±ÅŸÄ±nda seÃ§imde uyarÄ± gÃ¶sterilir

---

## [KR-022] Fiyat YÃ¶netimi PolitikasÄ±

- Fiyatlar uygulamada serbest **yazÄ±lmaz**; tek kaynak **PriceBook** (Fiyat KataloÄŸu)
- DeÄŸiÅŸiklik sadece **ADMIN** rolÃ¼nden yÃ¶netim paneliyle
- Versiyonlu + tarih aralÄ±klÄ±; geÃ§miÅŸ sipariÅŸlerin fiyatÄ± sonradan **deÄŸiÅŸmez**
- SipariÅŸ/abonelik oluÅŸurken fiyat snapshot sipariÅŸe yazÄ±lÄ±r
- DeÄŸiÅŸiklikler **audit log'a yazÄ±lÄ±r**

---
## [KR-023] Ã–rnek Fiyat Kurgusu (Pamuk)

| SeÃ§enek | Liste Fiyat | Ä°lk YÄ±l / Abonelik Kurgusu |
|---------|-------------|---------------------------|
| Tek seferlik analiz | 50 TL/dÃ¶nÃ¼m/analiz | Ä°lk yÄ±l tanÄ±tÄ±m: %50 indirim â†’ 25 TL/dÃ¶nÃ¼m/analiz |
| YÄ±llÄ±k abonelik | - | TanÄ±tÄ±m fiyatÄ± Ã¼zerinden ekstra %25 indirim â†’ 20 TL/dÃ¶nÃ¼m (yÄ±llÄ±k birim) |
---

## [KR-024] Ã–nerilen Tarama Periyodu (GÃ¼n)

| Bitki | Ã–nerilen Periyot (gÃ¼n) |
|-------|------------------------|
| Pamuk | 7-10 |
| Antep FÄ±stÄ±ÄŸÄ± | 10-15 |
| MÄ±sÄ±r | 15-20 |
| BuÄŸday | 10-15 |
| AyÃ§iÃ§eÄŸi | 7-10 |
| ÃœzÃ¼m | 7-10 |
| Zeytin | 15-20 |
| KÄ±rmÄ±zÄ± Mercimek | 10-15 |

---

## [KR-025] Analiz Ä°Ã§eriÄŸi (Hizmet KapsamÄ±)

**Temel Ä°lke:** Sistem ilaÃ§lama kararÄ± **vermez**; yalnÄ±zca tespit, risk skoru ve erken uyarÄ± saÄŸlar.

**Rapor Ã‡Ä±ktÄ±sÄ± (tarla + bitki bazÄ±nda):**
- Health Score
- Su/azot stresi
- HastalÄ±k/mantar bulgularÄ±
- ZararlÄ± bÃ¶cek riski
- YabancÄ± ot yoÄŸunluÄŸu

---

## [KR-026] Sunum BiÃ§imi

- Harita katmanlarÄ± (Ä±sÄ± haritasÄ± / grid / zonlama)
- Zaman serisi (yÄ±llÄ±k abonelikte karÅŸÄ±laÅŸtÄ±rma)
- Ã–zet rapor (PDF ve/veya uygulama iÃ§i rapor)

---

## [KR-027] Abonelik PlanlayÄ±cÄ± (Subscription Scheduler)

**AmaÃ§:** YÄ±llÄ±k abonelik seÃ§en kullanÄ±cÄ±lar iÃ§in otomatik, periyodik Mission Ã¼retimi.

**Tek Seferlik vs YÄ±llÄ±k:**
- **Tek seferlik:** KullanÄ±cÄ± talep eder â†’ 1 Mission â†’ tamamlanÄ±r
- **YÄ±llÄ±k:** KullanÄ±cÄ± periyot seÃ§er â†’ ilk Mission + scheduler â†’ otomatik yeni Missionlar

**Veri Modeli:**

```sql
create table subscriptions (
  subscription_id uuid primary key,
  farmer_user_id uuid not null,
  field_id uuid not null,
  crop_type text not null,
  analysis_type text not null,
  interval_days int not null check (interval_days > 0),
  start_date date not null,
  end_date date not null,
  next_due_at timestamptz not null,
  status text not null check (status in ('PENDING_PAYMENT','ACTIVE','PAUSED','CANCELLED')),
  price_snapshot_id uuid not null,
  payment_intent_id uuid null references payment_intents(payment_intent_id),
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create index idx_subscriptions_due on subscriptions(status, next_due_at);
create index idx_subscriptions_field on subscriptions(field_id, status);
create index idx_subscriptions_payment_intent on subscriptions(payment_intent_id);
```

**Scheduler KuralÄ±:**
1. Her gÃ¼n/saat cron job Ã§alÄ±ÅŸÄ±r
2. `status=ACTIVE AND next_due_at <= now()` abonelikleri bulur
3. Her biri iÃ§in yeni Mission oluÅŸturur (status=PLANNED)
4. `next_due_at = next_due_at + interval_days` gÃ¼ncellenir
5. Duplicate Ã¶nlemek iÃ§in `FOR UPDATE SKIP LOCKED` kullanÄ±lÄ±r

**Scheduler SQL:**
```sql
select subscription_id
from subscriptions
where status='ACTIVE' and next_due_at <= now()
for update skip locked;
```

**API Endpoint'leri:**
- `POST /subscriptions` â€” yeni abonelik oluÅŸtur
- `GET /subscriptions/{id}` â€” detay gÃ¶rÃ¼ntÃ¼le
- `POST /subscriptions/{id}/pause` â€” duraklat (PAUSED)
- `POST /subscriptions/{id}/resume` â€” devam ettir (ACTIVE)
- `POST /subscriptions/{id}/cancel` â€” iptal et (CANCELLED)

---

## [KR-028] Mission YaÅŸam DÃ¶ngÃ¼sÃ¼ ve SLA AlanlarÄ±

**Mission TanÄ±mÄ±:** Bir tarlanÄ±n belirli bir tarihte yapÄ±lacak tek analiz gÃ¶revi. Tek seferlik talepten veya yÄ±llÄ±k abonelikten oluÅŸabilir.

**Veri Modeli:**

```sql
create table missions (
  mission_id uuid primary key,
  field_id uuid not null,
  subscription_id uuid null references subscriptions(subscription_id),
  payment_intent_id uuid null references payment_intents(payment_intent_id),
  requested_by_user_id uuid not null,
  crop_type text not null,
  analysis_type text not null,
  status text not null check (status in (
    'PLANNED','ASSIGNED','ACKED','FLOWN','UPLOADED','ANALYZING','DONE','FAILED','CANCELLED'
  )),
  -- SLA zaman damgalarÄ±
  planned_at timestamptz null,
  due_at timestamptz null,
  flown_at timestamptz null,
  uploaded_at timestamptz null,
  analyzed_at timestamptz null,
  price_snapshot_id uuid not null,
  created_at timestamptz not null default now()
);

create index idx_missions_status_due on missions(status, due_at);
create index idx_missions_field_created on missions(field_id, created_at desc);
create index idx_missions_subscription on missions(subscription_id, created_at desc);
create index idx_missions_payment_intent on missions(payment_intent_id);

-- Mission plan / rota dosyasÄ± (KML/KMZ/WPML)
create table mission_route_files (
  mission_id uuid primary key references missions(mission_id),
  parcel_ref text not null,
  route_file_type text not null check (route_file_type in ('KML','KMZ','WPML')),
  route_file_version text null,
  route_file_hash_sha256 text null,
  created_at timestamptz not null default now()
);

create index idx_route_files_parcel on mission_route_files(parcel_ref);
```

**Status GeÃ§iÅŸleri:**
```
PLANNED â†’ ASSIGNED â†’ ACKED â†’ FLOWN â†’ UPLOADED â†’ ANALYZING â†’ DONE
                                                          â†˜ FAILED
                                                          â†˜ CANCELLED
```

**Pilot Inbox (Bekleyen GÃ¶revler):**
```sql
select mission_id, field_id, crop_type, analysis_type, planned_at, due_at, status
from missions
where status in ('PLANNED','ASSIGNED','ACKED')
order by due_at nulls last, created_at asc;
```

**Mission - Subscription Ä°liÅŸkisi:**
- `subscription_id` null ise: tek seferlik analiz
- `subscription_id` dolu ise: yÄ±llÄ±k abonelikten otomatik Ã¼retilmiÅŸ

---

## [KR-029] YZ EÄŸitim Geri Bildirimi (Training Feedback Loop)

**AmaÃ§:** Uzman dÃ¼zeltmelerini YZ modeline geri beslemek ve model iyileÅŸtirmesi yapmak.

**Veri Modeli:**

```sql
create table feedback_records (
  feedback_id uuid primary key,
  review_id uuid not null,
  mission_id uuid not null,
  model_id text not null,
  verdict text not null check (verdict in ('confirmed','corrected','rejected','needs_more_expert')),
  corrected_class text null,
  notes text null,
  time_spent_seconds int null,
  training_grade text not null check (training_grade in ('A','B','C','D','REJECT')),
  grade_reason text null,
  expert_confidence numeric(4,3) null,
  image_quality numeric(4,3) null,
  no_conflict boolean null,
  created_at timestamptz not null default now()
);

create index idx_feedback_grade on feedback_records(training_grade, created_at desc);
create index idx_feedback_mission_created on feedback_records(mission_id, created_at desc);
```

**Uzman Verdict Payload (API):**
```json
{
  "verdict": "confirmed | corrected | rejected | needs_more_expert",
  "corrected_class": "string (verdict=corrected ise zorunlu)",
  "notes": "string (corrected/rejected ise zorunlu)",
  "time_spent_seconds": 123
}
```

**RabbitMQ Mesaj ÅžemasÄ± (`ai.feedback.v1`):**
```json
{
  "schema_version": "ai.feedback.v1",
  "feedback_id": "uuid",
  "mission_id": "uuid",
  "model_id": "string",
  "crop_type": "pamuk",
  "analysis_type": "disease",
  "verdict": "corrected",
  "corrected_class": "verticillium_wilt",
  "training_grade": "A",
  "grade_reason": "high_conf + high_quality",
  "asset_refs": {
    "rgb_uri": "s3://.../rgb.tif",
    "ms_uri": "s3://.../ms.tif"
  },
  "created_at": "2026-01-27T00:00:00Z"
}
```

**Expert_reviews vs Feedback_records:**
- `expert_reviews` â†’ Uzman portal UI iÃ§in (review assignment, status tracking)
- `feedback_records` â†’ YZ training pipeline iÃ§in (pure data export)
- Ä°liÅŸki: `feedback_records.review_id` â†’ `expert_reviews.review_id`

---

## [KR-032] Training Export StandardÄ±

**AmaÃ§:** Uzman feedback'lerini standart formatta export ederek model eÄŸitim pipeline'Ä±na aktarmak.

### Format 1: JSONL (SÄ±nÄ±flandÄ±rma DÃ¼zeltmeleri)

**Dosya adÄ±:** `training_feedback_cls_v1.jsonl`  
**Schema:** `training.feedback.cls.v1`  
**Format:** Her satÄ±r bir JSON Ã¶rneÄŸi

```json
{"schema_version":"training.feedback.cls.v1","feedback_id":"...","mission_id":"...","crop_type":"pamuk","analysis_type":"disease","model_id":"m1","model_pred":"fusarium_wilt","model_conf":0.68,"expert_verdict":"corrected","corrected_class":"verticillium_wilt","training_grade":"A","grade_reason":"corrected+high_conf","rgb_uri":"s3://.../rgb.tif","ms_uri":"s3://.../ms.tif","created_at":"2026-01-27T00:00:00Z"}
```

### Format 2: GeoJSON (Segmentation/Alan Verileri)

**Dosya adÄ±:** `training_feedback_geo_v1.geojson`  
**Schema:** `training.feedback.geo.v1`

```json
{
  "type": "FeatureCollection",
  "schema_version": "training.feedback.geo.v1",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "feedback_id": "...",
        "mission_id": "...",
        "crop_type": "pamuk",
        "analysis_type": "disease",
        "training_grade": "B",
        "verdict": "confirmed"
      },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[[29.0,41.0],[29.1,41.0],[29.1,41.1],[29.0,41.1],[29.0,41.0]]]
      }
    }
  ]
}
```

### Admin Export Endpoint

**Endpoint:** `POST /admin/training/export`

**Request:**
```json
{
  "format": "JSONL_CLS_V1 | GEOJSON_V1",
  "from": "2026-01-01",
  "to": "2026-01-31",
  "min_grade": "B"
}
```

**Export SQL:**
```sql
select *
from feedback_records
where created_at::date between :from and :to
  and training_grade in ('A','B')  -- min_grade parametresine gÃ¶re
order by created_at asc;
```

**Schema Versiyonlama:**
- v1.x: geriye uyumlu eklemeler (optional field)
- v2.0: breaking change (schema migration gerektirir)

---

## [KR-030] Notlar, SÄ±nÄ±rlar ve Uyum

- **Drone standardÄ±:** BaÅŸlangÄ±Ã§ta DJI Mavic 3M dÄ±ÅŸÄ±nda veri kabul edilmez (sonraki fazda deÄŸerlendirilir)
- GÃ¶rÃ¼ntÃ¼ler yerel istasyon Ã¼zerinden sisteme alÄ±nÄ±r; log kayÄ±tlarÄ± denetim izi oluÅŸturur
- **KVKK:** PII ile operasyon/raporlama verisi ayrÄ±dÄ±r; il operatÃ¶rÃ¼ PII gÃ¶rmez
- Model Ã§Ä±ktÄ±sÄ± karar deÄŸildir; nihai aksiyon Ã§iftÃ§i ve/veya ziraat mÃ¼hendisinin sorumluluÄŸundadÄ±r

---

## [KR-031] Pilot HakediÅŸ ve Ã–deme PolitikasÄ±

- Pilotlar, bir ay iÃ§inde **ONAYLANMIÅž** gÃ¶revlerde taradÄ±klarÄ± alan Ã¼zerinden hakediÅŸ kazanÄ±r
- Ã–deme dÃ¶nemi: takip eden ayÄ±n ilk haftasÄ± (1-7 arasÄ±) toplu Ã¶deme
- Birim fiyat: **varsayÄ±lan 3 TL/dÃ¶nÃ¼m**; il bazÄ±nda CENTRAL_ADMIN tanÄ±mlayabilir (PilotRateByProvince)
- Ã–neri: ay sonu 23:59 cut-off + 3 iÅŸ gÃ¼nÃ¼ itiraz penceresi + ilk 7 gÃ¼n iÃ§inde Ã¶deme
- **Observed kapsama-izi olmadan Ã¶deme YOK; MissionID eÅŸleÅŸmeden Ã¶deme YOK**


## [KR-033] Ã–deme ve Manuel Onay (MÃ¼ÅŸteri Tahsilat AkÄ±ÅŸÄ±)

**AmaÃ§:** Ã‡iftÃ§i / Kooperatif / Ãœretici BirliÄŸi tarafÄ±ndan aÃ§Ä±lan **tek seferlik Mission** veya **yÄ±llÄ±k Subscription** taleplerinde tahsilatÄ± standartlaÅŸtÄ±rmak ve talebin â€œiÅŸlenebilirâ€ hale gelmesini **Ã¶deme onayÄ±na** baÄŸlamak.

> âš ï¸ **PII Notu:** Kimlik modeli gereÄŸi kullanÄ±cÄ± e-postasÄ± sistemde zorunlu alan deÄŸildir. IBAN/EFT ile Ã¶deme senaryosunda kullanÄ±cÄ± dekontu **odeme@tarlaanaliz.com** adresine kendi e-postasÄ±yla gÃ¶nderebilir; platform DBâ€™de e-posta adresi tutulmaz. Dekont/ek yÃ¶netimi iÃ§in platform DBâ€™de yalnÄ±zca `receipt_blob_id` gibi opak bir referans tutulur (object store / PII vault).  

### 1) Ã–deme YÃ¶ntemleri (Payment Method)

- `CREDIT_CARD` (Kredi kartÄ± / online): Ã–deme saÄŸlayÄ±cÄ±sÄ± Ã¼zerinden tahsilat (hosted checkout / payment session).  
- `IBAN_TRANSFER` (Havale/EFT): KullanÄ±cÄ± IBANâ€™a transfer yapar; aÃ§Ä±klamaya `PaymentRef` yazar; dekontu e-posta ile iletir; **Merkez YÃ¶netim (CENTRAL_ADMIN)** manuel onay verir.

### 2) Ã–deme DurumlarÄ± (Payment Status)

`PaymentIntent.status` kanonik durumlarÄ±:

- `PAYMENT_PENDING` â†’ Ã¶deme bekleniyor (intent aÃ§Ä±ldÄ±, tahsilat doÄŸrulanmadÄ±)
- `PAID` â†’ Ã¶deme tamamlandÄ± (provider webhook veya manuel admin onayÄ±)
- `REJECTED` â†’ Ã¶deme reddedildi (dekont/uyuÅŸmazlÄ±k/eksik bilgi)
- `EXPIRED` â†’ sÃ¼re aÅŸÄ±ldÄ± (Ã¶rn. 7 gÃ¼n iÃ§inde Ã¶deme gelmezse)
- `CANCELLED` â†’ Ã¶deme intentâ€™i iptal edildi (kullanÄ±cÄ±/admin; **PAID olmadan**)
- `REFUNDED` â†’ Ã¶deme iade edildi (**yalnÄ±zca PAID sonrasÄ±**)

**Kural-1 (Mission):** `PAID` olmadan Mission **ASSIGNED** olamaz.  
**Kural-2 (Subscription):** `PAID` olmadan Subscription **ACTIVE** olamaz; `PENDING_PAYMENT` durumunda scheduler Mission Ã¼retmez.  
**Kural-3 (Ä°ptal):** `PAYMENT_PENDING` iken kullanÄ±cÄ± `CANCELLED` yapabilir.  
**Kural-4 (Ä°ade):** `REFUNDED` yalnÄ±zca `PAID` sonrasÄ± admin aksiyonu ile olur; iade edilen Ã¶deme, hedefe gÃ¶re aÅŸaÄŸÄ±daki politikayÄ± tetikler.

### 3) MÃ¼ÅŸteri Tahsilat AkÄ±ÅŸÄ± (Payment Flow)

**Tek seferlik analiz (Mission)**
1. KullanÄ±cÄ± Mission talebi oluÅŸturur â†’ sistem `price_snapshot_id` Ã¼retir.
2. Sistem bir `PaymentIntent` Ã¼retir (`PAYMENT_PENDING`) ve kullanÄ±cÄ±ya yÃ¶ntem seÃ§tirir.
3. `CREDIT_CARD`: hosted checkout â†’ webhook/redirect â†’ `PAID` â†’ Mission â€œiÅŸlenebilirâ€ hale gelir.
4. `IBAN_TRANSFER`: uygulama IBAN + `PaymentRef` + dekont e-posta talimatÄ± gÃ¶sterir â†’ admin manuel kontrol â†’ `PAID` veya `REJECTED`.
5. `PAID` olunca Mission atama kuyruÄŸuna girer (PLANNED/ASSIGNED akÄ±ÅŸÄ±na uygun).

**YÄ±llÄ±k abonelik (Subscription)**
1. KullanÄ±cÄ± aboneliÄŸi baÅŸlatÄ±r â†’ Subscription `PENDING_PAYMENT` aÃ§Ä±lÄ±r, `price_snapshot_id` yazÄ±lÄ±r.
2. Sistem Subscription hedefli bir `PaymentIntent` Ã¼retir (`PAYMENT_PENDING`).
3. `PAID` olunca Subscription `ACTIVE` olur ve scheduler Ã§alÄ±ÅŸÄ±r.

**IBAN Talimat EkranÄ± (PWA)**
- IBAN (kopyala)
- AlÄ±cÄ± adÄ±
- Tutar
- `PaymentRef` (kopyala)
- â€œAÃ§Ä±klamaya PaymentRef yaz; dekontu odeme@tarlaanaliz.com adresine gÃ¶nder; konu satÄ±rÄ± PaymentRef olsun.â€

### 4) Veri Modeli (PostgreSQL)

```sql
-- Payment intent: hedefi Mission veya Subscription olabilir
create table payment_intents (
  payment_intent_id uuid primary key,

  payer_user_id uuid not null,
  coop_id uuid null,

  target_type text not null check (target_type in ('MISSION','SUBSCRIPTION')),
  target_id uuid not null,

  amount_kurus bigint not null check (amount_kurus > 0),
  currency text not null default 'TRY',

  method text not null check (method in ('CREDIT_CARD','IBAN_TRANSFER')),
  status text not null check (status in ('PAYMENT_PENDING','PAID','REJECTED','EXPIRED','CANCELLED','REFUNDED')),

  payment_ref text not null unique,     -- Ã¶rn: PAY-20260129-4F8K2Q
  price_snapshot_id uuid not null,      -- immutable pricing snapshot

  -- Kredi kartÄ± tarafÄ± (opsiyonel; kart bilgisi asla tutulmaz)
  provider text null,                   -- iyzico/paytr/...
  provider_session_id text null,
  provider_payment_id text null,

  -- Havale dekontu (platform DB PII tutmaz)
  receipt_blob_id text null,            -- object store referansÄ±
  receipt_meta jsonb null,              -- {"source":"email","message_id_hash":"..."} (PII iÃ§ermez)

  -- Manuel onay / iade / iptal
  approved_by_admin_user_id uuid null,
  approved_at timestamptz null,
  paid_at timestamptz null,

  rejected_at timestamptz null,
  rejected_reason text null,

  cancelled_at timestamptz null,
  cancelled_reason text null,

  refunded_at timestamptz null,
  refund_amount_kurus bigint null,
  refund_reason text null,

  expires_at timestamptz null,

  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create index idx_payment_intents_target on payment_intents(target_type, target_id);
create index idx_payment_intents_status on payment_intents(status, created_at desc);
create index idx_payment_intents_payer on payment_intents(payer_user_id, created_at desc);
```

**Mission / Subscription BaÄŸlantÄ±sÄ± (ÅŸema gÃ¼ncellemesi)**

```sql
-- Tek seferlik Mission'lar payment_intent_id taÅŸÄ±r; subscription Ã¼zerinden gelen Mission'lar null olabilir
alter table missions add column payment_intent_id uuid null references payment_intents(payment_intent_id);
create index idx_missions_payment_intent on missions(payment_intent_id);

-- Subscription Ã¶deme bekleme durumu + payment intent iliÅŸkisi
-- Not: status seti KR-027 ile gÃ¼ncellenir (PENDING_PAYMENT eklenir)
alter table subscriptions add column payment_intent_id uuid null references payment_intents(payment_intent_id);
create index idx_subscriptions_payment_intent on subscriptions(payment_intent_id);
```

### 5) API Endpointâ€™leri (Platform)

**Farmer/Coop**
- `POST /payments/intents` â€” PaymentIntent oluÅŸtur (mission/subscription iÃ§in)
- `GET /payments/intents/{id}` â€” durum gÃ¶rÃ¼ntÃ¼le
- `GET /payments/intents/{id}/instructions` â€” IBAN talimatÄ± / provider checkout bilgisi
- `POST /payments/intents/{id}/cancel` â€” (PENDING iken) iptal

**Provider callback**
- `POST /payments/webhook/{provider}` â€” Ã¶deme saÄŸlayÄ±cÄ± callback/webhook

**Admin (CENTRAL_ADMIN)**
- `GET /admin/payments/intents?status=PAYMENT_PENDING` â€” bekleyen tahsilatlar
- `POST /admin/payments/intents/{id}/attach-receipt` â€” dekont referansÄ± ekle (`receipt_blob_id`)
- `POST /admin/payments/intents/{id}/mark-paid` â€” manuel onay
- `POST /admin/payments/intents/{id}/reject` â€” manuel red
- `POST /admin/payments/intents/{id}/refund` â€” iade (PAID â†’ REFUNDED)

### 6) Otomatik SÃ¼re Dolma PolitikasÄ± (Expire)

- `IBAN_TRANSFER` iÃ§in intent aÃ§Ä±ldÄ±ktan sonra **7 gÃ¼n** iÃ§inde Ã¶deme doÄŸrulanmazsa:
  - `PAYMENT_PENDING â†’ EXPIRED`
  - kullanÄ±cÄ±ya SMS + uygulama iÃ§i bildirim

### 7) Bildirimler (SMS + Uygulama Ä°Ã§i)

- `PAYMENT_PENDING` â†’ â€œÃ–deme bekleniyor. Ref: {PaymentRef}. IBAN ekranÄ±ndaki talimata gÃ¶re dekontu odeme@tarlaanaliz.com adresine gÃ¶nder.â€
- `PAID` â†’ â€œÃ–demeniz alÄ±ndÄ±. Talebiniz iÅŸleme alÄ±ndÄ±.â€
- `REJECTED` â†’ â€œÃ–demeniz reddedildi. Neden: {reason}â€
- `EXPIRED` â†’ â€œÃ–deme sÃ¼resi doldu. Ref: {PaymentRef}â€
- `CANCELLED` â†’ â€œTalebiniz iptal edildi. Ref: {PaymentRef}â€
- `REFUNDED` â†’ â€œÃ–demeniz iade edildi. Ref: {PaymentRef}â€

### 8) Ä°ptal / Ä°ade PolitikasÄ± (Kanonik)

- **Ä°ptal (CANCELLED):** yalnÄ±zca `PAYMENT_PENDING` iken yapÄ±lÄ±r.  
- **Ä°ade (REFUNDED):** yalnÄ±zca `PAID` iken admin aksiyonu ile yapÄ±lÄ±r.
- **Ä°ade + Mission iliÅŸkisi:** Mission henÃ¼z `FLOWN` aÅŸamasÄ±na gelmediyse Mission `CANCELLED` yapÄ±labilir; `FLOWN/UPLOADED/ANALYZING/DONE` sonrasÄ± iade kararÄ± ticari politikadÄ±r ama sistemde `REFUNDED` tutulabilir (geri Ã¶deme ayrÄ± gateway iÅŸlemi olabilir).
- **Ä°ade + Subscription iliÅŸkisi:** Subscription `ACTIVE` iken iade edilirse Subscription `CANCELLED` yapÄ±lÄ±r ve yeni Mission Ã¼retilmez (mevcut Missionlar ayrÄ±ca iptal edilebilir).

### 9) Audit Log (WORM) â€” Minimum Olaylar

- `PAYMENT.INTENT_CREATED`
- `PAYMENT.MARK_PAID` / `PAYMENT.WEBHOOK_PAID`
- `PAYMENT.REJECTED`
- `PAYMENT.EXPIRED`
- `PAYMENT.CANCELLED`
- `PAYMENT.REFUNDED`

> Bu olaylar BÃ–LÃœM 3 log standardÄ±na uygun ÅŸekilde JSONL olarak Ã¼retilir; `correlation_id` zorunludur; PII yoktur.

---

## [KR-040] GÃ¼venlik Kabul Kriterleri/Test Checklist (SDLC Entegrasyonu)

**AmaÃ§:** TXT repo mantalitesindeki savunma-derinliÄŸi (defense-in-depth) gÃ¼venlik yaklaÅŸÄ±mÄ±nÄ±, Ã¶lÃ§Ã¼lebilir kabul kriterlerine ve SDLC kapÄ±larÄ±na (PR/CI/Release/Ops) baÄŸlamak.

**Yer:** Ä°ÅŸ PlanÄ± seviyesinde politika ve denetim beklentileri. Bu ek, Ã¼rÃ¼n ve saha dokÃ¼manlarÄ± iÃ§in baÄŸlayÄ±cÄ± kabul kriteridir.

---

## [KR-041] SDLC KapÄ±larÄ± (Gate) - Zorunlu Kontroller

### PR Gate (merge Ã¶ncesi)
- Contracts pinleme: CONTRACTS_VERSION (SemVer) + CONTRACTS_SHA256 zorunlu; deÄŸiÅŸiklikte breaking-change kontrolÃ¼
- Unit test: kritik gÃ¼venlik fonksiyonlarÄ± (hash, imza doÄŸrulama, allowlist, RBAC) %80+ satÄ±r kapsama hedefi
- Secret scan: repo iÃ§inde anahtar/sertifika/PIN bulunmayacak (pre-commit + CI)
- Lint/Type-check: statik analiz hatasÄ±z; ÅŸema validasyonu (OpenAPI/JSON Schema) Ã§alÄ±ÅŸÄ±r

### CI Gate (pipeline)
- Integration test: EdgeKiosk â†’ Backend mTLS el sÄ±kÄ±ÅŸmasÄ± + cihaz kimliÄŸi doÄŸrulama
- Contract test: DTO/Schema Ã¼retimi + geriye dÃ¶nÃ¼k uyumluluk (backward-compatible) kontrolÃ¼
- SAST/Dependency scan: bilinen kritik zafiyet yok (CVSS yÃ¼ksek olanlar blok)
- Container scan + SBOM: imaj taramasÄ± temiz; SBOM Ã¼retilir ve arÅŸivlenir

### Release Gate (prod'a Ã§Ä±kÄ±ÅŸ)
- SÃ¼rÃ¼mleme: release notlarÄ± + migration planÄ±; breaking change varsa sÃ¼rÃ¼m artÄ±ÅŸÄ± ve geriye uyumluluk stratejisi
- Smoke test: uÃ§tan uca Ã¶rnek akÄ±ÅŸ (Mission create â†’ ingest â†’ worker â†’ sonuÃ§ â†’ harita katmanÄ±) baÅŸarÄ±lÄ±
- Sertifika yÃ¶netimi: kiosk sertifikalarÄ± basÄ±lÄ±/daÄŸÄ±tÄ±lmÄ±ÅŸ; rotasyon takvimi kayÄ±tlÄ±
- Rollback planÄ±: veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ bozmadan geri dÃ¶nÃ¼ÅŸ adÄ±mlarÄ± tanÄ±mlÄ±

### Ops Checklist (gÃ¼nlÃ¼k/haftalÄ±k)
- Karantina kuyruÄŸu: bekleyen dosya/mission sayÄ±sÄ± ve sebepleri raporlanÄ±r
- Audit/WORM log doÄŸrulamasÄ±: loglarÄ±n deÄŸiÅŸmediÄŸi kontrol edilir, saklama sÃ¼resi politikasÄ± izlenir
- Anahtar/sertifika rotasyonu: sÃ¼re dolumu yaklaÅŸanlar listelenir, planlÄ± yenileme yapÄ±lÄ±r
- Anomali izleme: olaÄŸandÄ±ÅŸÄ± ingest hÄ±zÄ±, tekrar eden baÅŸarÄ±sÄ±z doÄŸrulama, ÅŸÃ¼pheli IP/cihaz hareketleri alarm Ã¼retir

---

## [KR-042] Kabul Kriterleri Matrisi

| GÃ¼venlik KatmanÄ± | Kabul Kriteri (DoD) | Test KanÄ±tÄ± | SDLC Gate |
|------------------|---------------------|-------------|-----------|
| Kimlik & Yetki (RBAC) + PII ayrÄ±mÄ± | Ä°l OperatÃ¶rÃ¼ ve saha rolleri PII gÃ¶rmez; sadece FieldID/Ã¶zet KPI gÃ¶rÃ¼r. Admin iÅŸlemleri audit log Ã¼retir. | RBAC unit + API yetki e2e; negatif test: yetkisiz eriÅŸim 403. Audit log kaydÄ± doÄŸrulanÄ±r. | PR + CI |
| Cihaz kimliÄŸi + mTLS | Sadece kayÄ±tlÄ± kiosk cihazÄ±, sertifikalÄ± mTLS ile ingest endpoint'ine eriÅŸebilir; sertifika iptali anÄ±nda bloklar. | Integration test: mTLS baÅŸarÄ±lÄ±/baÅŸarÄ±sÄ±z senaryolar; sertifika revocation testi. | CI + Release |
| Veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼: SHA-256 manifest + imza | Her ingest paketi iÃ§in manifest (dosya listesi + hash) ve imza zorunlu; hash uyuÅŸmazsa karantina. | Unit test (hash/manifest), e2e: bozuk dosya â†’ karantina + alarm. | PR + CI |
| Allowlist / iÃ§erik doÄŸrulama | Sadece izinli uzantÄ±/MIME; maksimum boyut/Ã§Ã¶zÃ¼nÃ¼rlÃ¼k limitleri; zip-slip ve path traversal engelli. | Unit test: uzantÄ±/MIME; fuzz test Ã¶rnekleri; e2e negatif senaryo. | PR + CI |
| ZararlÄ± taramasÄ± (AV/EDR) + karantina | AV taramasÄ± geÃ§meden hiÃ§bir dosya iÅŸ akÄ±ÅŸÄ±na giremez; ÅŸÃ¼pheli iÃ§erik karantinaya alÄ±nÄ±r, etiketlenir. | E2e senaryo: EICAR test dosyasÄ± â†’ karantina + olay kaydÄ±. | CI + Ops |
| Air-gapped karantina PC + tek yÃ¶nlÃ¼ aktarÄ±m | Karantina PC internetsiz; dÄ±ÅŸ medya steril prosedÃ¼rÃ¼; Ã§Ä±ktÄ± sadece imzalÄ± paket olarak ilerler. | SOP denetim checklisti + Ã¶rnek denetim kaydÄ±. | Release + Ops |
| Zincir-of-custody + immutable (WORM) audit | MissionID/BatchID/CardID ve iÅŸlem adÄ±mlarÄ± deÄŸiÅŸtirilemez logda; log saklama sÃ¼resi uygulanÄ±r. | Log bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ kontrolÃ¼ + denetim raporu; e2e: ingest adÄ±mÄ± log zinciri. | CI + Ops |
| Secrets yÃ¶netimi (rotasyon) | HiÃ§bir secret repo'da yok; vault/secret store; rotasyon periyodu tanÄ±mlÄ±; sÄ±zma halinde iptal prosedÃ¼rÃ¼. | Secret scan raporu + rotasyon kaydÄ± + revocation drill Ã§Ä±ktÄ±sÄ±. | PR + Release + Ops |
| Rate limiting + anomali tespiti | Ingest ve auth endpoint'lerinde rate limit; tekrar eden baÅŸarÄ±sÄ±z doÄŸrulama alarmlarÄ±. | Load test + saldÄ±rÄ± simÃ¼lasyonu (Ã§oklu deneme) â†’ 429 ve alarm. | CI + Ops |
| AI izolasyonu + least privilege | Worker sadece job kuyruÄŸu/sonuÃ§ yazma yetkisine sahip; ham PII yok; aÄŸ eriÅŸimi minimum. | IAM policy testi + container/network policy doÄŸrulama; e2e job akÄ±ÅŸÄ±. | CI + Release |

---

## [KR-043] Test Checklist (Senaryo BazlÄ±)

| Senaryo | AdÄ±mlar (Ã¶zet) | Beklenen SonuÃ§ | KanÄ±t/Artefakt |
|---------|----------------|----------------|----------------|
| SC-01: Normal ingest (offline â†’ senkron) | Pilot gÃ¶rev dosyasÄ± â†’ uÃ§uÅŸ â†’ SD ingest â†’ manifest doÄŸrula â†’ AV tarama â†’ upload/queue â†’ worker sonuÃ§ â†’ harita katmanÄ± | TÃ¼m adÄ±mlar baÅŸarÄ±lÄ±; sonuÃ§ katmanÄ± oluÅŸur; audit zinciri tam | E2E test raporu + log zinciri + sonuÃ§ ekran gÃ¶rÃ¼ntÃ¼sÃ¼ |
| SC-02: Hash uyuÅŸmazlÄ±ÄŸÄ± | Manifestteki bir dosyayÄ± deÄŸiÅŸtir â†’ ingest | Karantina; olay kaydÄ±; iÅŸleme alÄ±nmaz | Karantina kaydÄ± + alarm kaydÄ± |
| SC-03: Yetkisiz cihaz | mTLS sertifikasÄ± olmayan cihazla ingest dene | EriÅŸim reddi; audit log + alarm | Integration test Ã§Ä±ktÄ±sÄ± + log |
| SC-04: EICAR/zararlÄ± iÃ§erik | Test imzasÄ± bulunan dosyayÄ± ingest et | AV blok + karantina | AV raporu + karantina kaydÄ± |
| SC-05: PII sÄ±zma testi | Ä°l OperatÃ¶rÃ¼ rolÃ¼yle PII endpoint'ine eriÅŸmeyi dene | 403; veri dÃ¶nmez; deneme audit log'a dÃ¼ÅŸer | RBAC e2e raporu |
| SC-06: Contract breaking change | Schema'da alan sil/isim deÄŸiÅŸtir | CI breaking-change detector fail; merge/release blok | CI artefaktÄ± + diff raporu |

---

## [KR-050] Kimlik DoÄŸrulama ve Ãœyelik AkÄ±ÅŸÄ± (Sade Model)

- Kimlik bilgisi olarak yalnÄ±zca **Telefon NumarasÄ±** kullanÄ±lÄ±r (E-posta ve TCKN **toplanmaz**)
- **KayÄ±t:** Telefon NumarasÄ± girilir ve 6 haneli sayÄ±sal PIN belirlenir
- **GiriÅŸ:** Telefon NumarasÄ± + 6 haneli PIN ile yapÄ±lÄ±r
- **DoÄŸrulama adÄ±mÄ± yoktur**; sÃ¼reÃ§ bilinÃ§li olarak sadeleÅŸtirilmiÅŸtir
- **PIN unutulursa:** Merkez/Kooperatif/Ä°l OperatÃ¶rÃ¼ panelinden PIN sÄ±fÄ±rlanÄ±r; kullanÄ±cÄ± ilk giriÅŸte yeni PIN belirler
- KullanÄ±cÄ±yÄ± yormayan minimum korumalar: giriÅŸ deneme sÄ±nÄ±rÄ± (rate limit) ve kÄ±sa sÃ¼reli kilitleme (lockout)

---

## [KR-060] ÃœrÃ¼n/Teknik Spesifikasyondan Normatif

## [KR-061] AmaÃ§ ve Sabit Ã‡erÃ§eve

Bu bÃ¶lÃ¼m, **[KR-001] Proje Ã–zeti** iÃ§indeki "Sabit Ã‡erÃ§eve" maddelerinin **normatif Ã¶zeti/aynÄ±sÄ±dÄ±r**.

- Kanonik kaynak: **[KR-001]**
- Bu bÃ¶lÃ¼mde tekrar eden maddeler kaldÄ±rÄ±ldÄ± (kural deÄŸiÅŸmedi).

---

## [KR-062] TasarÄ±m Ä°lkeleri

1. **Tek kaynak gerÃ§ek:** API ve veri modeli. Web (PWA) iÅŸ kuralÄ± kopyalamaz.
2. **Offline-first:** Yerel istasyon internetsiz Ã§alÄ±ÅŸabilir; senkronizasyon opsiyonel ve gÃ¼venli.
3. **Denetlenebilirlik (Audit Log):** Fiyat, kurum onayÄ±, eÅŸleÅŸtirme ve hakediÅŸ adÄ±mlarÄ±nda zorunlu log.
4. **EÅŸleÅŸtirme hiyerarÅŸisi:** MissionID â†’ BatchID â†’ FieldID â†’ CropSeason. MissionID yoksa coÄŸrafi kesiÅŸim + manuel kuyruk.

---

## [KR-063] Roller ve Yetkiler (RBAC)

| Rol Kodu | KÄ±sa TanÄ±m | Ã–zet Yetki |
|----------|------------|------------|
| FARMER_SINGLE | Tekil Ã§iftÃ§i | Tarla ekle, analiz talebi aÃ§, rapor gÃ¶rÃ¼ntÃ¼le |
| FARMER_MEMBER | Kurum Ã¼yesi Ã§iftÃ§i | Kendi tarlalarÄ± iÃ§in rapor gÃ¶r, kurum baÄŸlantÄ±sÄ±nÄ± onayla |
| COOP_OWNER | Kooperatif sahibi/yetkili | Paket satÄ±n alma, kullanÄ±cÄ± yÃ¶netimi, analiz talebi, dashboard |
| COOP_ADMIN | Kooperatif admin | Ãœye yÃ¶netimi, tarla ekleme, analiz talebi |
| COOP_AGRONOMIST | Kooperatif agronomist | Rapor gÃ¶r, not gir (aksiyon kararÄ± yok) |
| COOP_VIEWER | Kooperatif izleyici | Sadece Ã¶zet/rapor |
| PILOT | Drone pilotu | GÃ¶rev gÃ¶r, uÃ§uÅŸ yap, veri teslim et, hakediÅŸ Ã¶nizle |
| STATION_OPERATOR | Yerel istasyon operatÃ¶rÃ¼ | Kiosk ingest, eÅŸleÅŸtirme, karantina/antivirÃ¼s sonuÃ§larÄ± |
| IL_OPERATOR | Ä°l OperatÃ¶rÃ¼ | PII gÃ¶rmeden KPI/Ã¶zet gelir ve operasyon metrikleri |
| CENTRAL_ADMIN | Merkez yÃ¶netici | Fiyat/PriceBook, kurum onayÄ±, rol atama, audit |
| AI_SERVICE | YZ analiz servisi | Job tÃ¼ket, rapor Ã¼ret, sonuÃ§ yaz |
| EXPERT | Uzman | Ä°nceleme gÃ¶rÃ¼ntÃ¼le, verdict ver, PII gÃ¶rmez |

---

## [KR-064] Harita Katman StandardÄ± (Layer Registry)

Katmanlar web (PWA) arayÃ¼zÃ¼nde aynÄ± Layer Registry Ã¼zerinden tanÄ±mlanÄ±r. Renk + desen/ikon + opaklÄ±k + Ã¶ncelik tutarlÄ± olmalÄ±dÄ±r.

| LayerCode | Legend | Renk | Desen/Ä°kon | OpaklÄ±k | Ã–ncelik | Ã‡Ä±ktÄ± Tipi |
|-----------|--------|------|------------|---------|---------|------------|
| HEALTH | SaÄŸlÄ±k | YeÅŸil | Leaf ikon + gradient heatmap | 0.55 | 10 | Raster/Heatmap |
| WEED | YabancÄ± ot | SarÄ±/Hardal | NoktalÄ± desen + weed ikon | 0.60 | 60 | Polygon/Zone |
| DISEASE | HastalÄ±k | Turuncu | Ã‡apraz Ã§izgi + stethoscope ikon | 0.65 | 70 | Polygon/Zone |
| PEST | ZararlÄ± bÃ¶cek | KÄ±rmÄ±zÄ± | X/desen + bug ikon | 0.70 | 80 | Polygon/Zone |
| FUNGUS | Mantar | Mor | Ã‡apraz tarama + mushroom ikon | 0.65 | 75 | Polygon/Zone |
| WATER_STRESS | Su stresi | Mavi | Damla noktalÄ± desen + droplet ikon | 0.45 | 50 | Raster/Zone |
| N_STRESS | Azot stresi | Soluk gri | Ã‡apraz Ã§izgili desen + N ikon | 0.45 | 40 | Raster/Zone |

**Ã‡akÄ±ÅŸma kuralÄ±:** priority yÃ¼ksek katman Ã¼stte gÃ¶rÃ¼nÃ¼r. **EriÅŸilebilirlik iÃ§in ikon + desen zorunludur.**

---

## [KR-065] Pilot HakediÅŸ DoÄŸrulama (Expected vs Observed)

- **Expected Area:** FieldBoundary veya Mission flightplan sÄ±nÄ±rÄ± (mÂ²)
- **Observed Area:** GeoTIFF/ortomozaik kapsama-izi (kapsama) poligonu (mÂ²)

```python
coverage_ratio = Area(intersection(observed, expected)) / Area(expected)
```

**HakediÅŸ kuralÄ±:**
- `coverage_ratio >= 0.95` â†’ TAM Ã¶deme
- `0.80 <= coverage_ratio < 0.95` â†’ KISMÄ° + opsiyonel inceleme
- `coverage_ratio < 0.80` â†’ TEKRAR UÃ‡UÅž veya itiraz/inceleme

---

## [KR-066] GÃ¼venlik ve KVKK

- PII ayrÄ± veri alanÄ±nda tutulur; raporlama ve KPI katmanÄ± pseudonymous kimliklerle Ã§alÄ±ÅŸÄ±r
- Ä°l operatÃ¶rÃ¼: ilÃ§e veya 1-2 km grid yoÄŸunluk; isim/telefon/IBAN alanlarÄ±na **eriÅŸemez**
- Yerel istasyon: offline karantina, hash doÄŸrulama, antivirÃ¼s raporu ve zincir log (chain-of-custody)
- Drone seri no ve kart kimliÄŸi doÄŸrulama sahte veri enjeksiyon riskini azaltÄ±r
- Fiyat ve kurum onayÄ± deÄŸiÅŸiklikleri audit log zorunlu; snapshot ile geÃ§miÅŸ sipariÅŸler etkilenmez

---

## [KR-070] YZ Analiz Ä°zolasyonu
**AmaÃ§:** YZ (Worker) altyapÄ±sÄ±nÄ±n, web/platform tarafÄ±ndan â€œsorgulanabilir bir servisâ€ gibi kullanÄ±lmasÄ±nÄ± engellemek; model/ham veri yÃ¼zeyini kÃ¼Ã§Ã¼ltmek.

[ZORUNLU]
- YZ analiz altyapÄ±sÄ± **inbound istek kabul etmez**; yalnÄ±zca paket/dispatch ile job alÄ±r (bkz. **[KR-017]**)
- Web (PWA) ve public backend, Worker aÄŸÄ±na **doÄŸrudan eriÅŸemez** (ayrÄ± aÄŸ segmenti + mTLS + allowlist)
- EdgeKiosk/istasyon tarafÄ±nda **model Ã§alÄ±ÅŸtÄ±rma yoktur** (model hÄ±rsÄ±zlÄ±ÄŸÄ± riskini azaltmak iÃ§in)
- Model/servis eriÅŸimleri ve deny olaylarÄ± audit/WORM logâ€™a dÃ¼ÅŸer (bkz. **BÃ–LÃœM 3**)

**Ä°lgili maddeler:** [KR-066], [KR-017], [KR-040-043], EK-SOP-SEC, BÃ–LÃœM 3, BÃ–LÃœM 4
---

## [KR-080] Ana Ä°ÅŸ AkÄ±ÅŸlarÄ± iÃ§in Teknik Kurallar

Bu bÃ¶lÃ¼m; ana iÅŸ akÄ±ÅŸlarÄ±nÄ±n iÅŸ planÄ± anlatÄ±sÄ±nda zaten bulunan kÄ±sÄ±mlarÄ±nÄ± tekrar etmez. Sadece teknik spesifikasyonda eklenen/sertleÅŸtirilen kurallarÄ± listeler.

**Tarla Ekleme:**
- il/ilÃ§e/mahalle/kÃ¶y + ada/parsel + alan (mÂ²); sistem FieldID Ã¼retir
- Tekil kayÄ±t kuralÄ±: il+ilÃ§e+mahalle/kÃ¶y+ada+parsel kombinasyonu tekrar edemez
- Bitki tÃ¼rÃ¼ tanÄ±mÄ± (tarla bazÄ±nda); birden fazla bitki varsa alan (mÂ²) ile ayrÄ± ayrÄ±
- Analiz talebi: bitki tÃ¼rÃ¼ bazÄ±nda; yÄ±llÄ±k abonelik veya tek seferlik
- Bitki tÃ¼rÃ¼ deÄŸiÅŸimi: yÄ±lda 1 defa, sadece 1 Ekim - 31 AralÄ±k (backend kuralÄ±)

**Kooperatif:**
- BaÅŸvuru: evrak + 'Onay Bekliyor' durumunda aÃ§Ä±lÄ±r; admin onayÄ± ile 'Aktif' olur
- Ãœye daveti: QR / 6 haneli davet kodu; Ã§iftÃ§i hesabÄ±ndan baÄŸlantÄ±yÄ± onaylar (onay olmadan kooperatif adÄ±na iÅŸlem kÄ±sÄ±tlanabilir)
- Tarla tekil; sahiplik/eriÅŸim ayrÄ± yaklaÅŸÄ±mÄ± Ã¶nerilir (Ã§akÄ±ÅŸma/yanlÄ±ÅŸ ekleme riskine karÅŸÄ±)

**Pilot:**
- Pilot sadece DJI Mavic 3M kullanÄ±r; drone seri numarasÄ± doÄŸrulama referansÄ±dÄ±r
- GÃ¼nlÃ¼k teslim: uÃ§uÅŸ Ã§Ä±ktÄ±sÄ± her gÃ¼n hafÄ±za kartÄ± ile yerel istasyona aktarÄ±lÄ±r
- Her uÃ§uÅŸta farklÄ± hafÄ±za kartÄ± kullanÄ±lÄ±r. DJI tarafÄ±ndaki kart kilidi/PIN gibi Ã¶zellikler varsa opsiyonel ek katmandÄ±r; gÃ¼venlik garantisi deÄŸildir (bkz. [KR-015])
- EÅŸleÅŸtirme zorunlu: YÃ¼klenen Ã§ekimler kayÄ±tlÄ± tarla ile eÅŸleÅŸmezse iÅŸlenmez
- Pilot sonuÃ§ raporunu gÃ¶rmez; sadece operasyon durumu gÃ¶rÃ¼r

**Ä°l OperatÃ¶rÃ¼:**
- Ä°l operatÃ¶rÃ¼ PII gÃ¶rmez; sadece ticari KPI ve kapasite planlama metrikleri gÃ¶rÃ¼r
- CoÄŸrafya: ilÃ§e dÃ¼zeyi veya 1-2 km grid yoÄŸunluk katmanÄ± (pseudonymous)

---

## [KR-081] Kontrat ÅžemalarÄ± (Contract-First) â€” Kanonik JSON Schema

**AmaÃ§:** "olmalÄ±" seviyesinden Ã§Ä±kÄ±p, kodlamadan Ã¶nce ortak dilin **makine-doÄŸrulanabilir** (machine-verifiable) hale gelmesi.

Bu bÃ¶lÃ¼mde iki kanonik payload tanÄ±mÄ± dokÃ¼mana gÃ¶mÃ¼lÃ¼dÃ¼r ve `shared/contracts` Ã¼retiminin tek kaynaÄŸÄ± olarak kabul edilir.

### KR-081.1 AnalysisJob â€” JSON Schema (draft 2020-12)

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://tarlaanaliz.example/contracts/analysis_job.v1.schema.json",
  "title": "AnalysisJob",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version", "job_id", "created_at", "field", "crop", 
    "mission", "capture_set", "inputs", "processing", "pricing_snapshot", "status"
  ],
  "properties": {
    "schema_version": { "const": "analysis_job.v1" },
    "job_id": { "type": "string", "pattern": "^[0-9a-fA-F-]{36}$" },
    "idempotency_key": { "type": "string", "maxLength": 128 },
    "created_at": { "type": "string", "format": "date-time" },
    "field": {
      "type": "object",
      "required": ["field_id", "area_donum", "parcel_ref"],
      "properties": {
        "field_id": { "type": "string", "maxLength": 64 },
        "parcel_ref": { "type": "string", "maxLength": 128 },
        "area_donum": { "type": "number", "minimum": 0 }
      }
    },
    "crop": {
      "type": "object",
      "required": ["crop_code", "crop_name"],
      "properties": {
        "crop_code": { "type": "string", "maxLength": 32 },
        "crop_name": { "type": "string", "maxLength": 64 }
      }
    },
    "mission": {
      "type": "object",
      "required": ["mission_id", "flight_date", "drone"],
      "properties": {
        "mission_id": { "type": "string", "maxLength": 64 },
        "flight_date": { "type": "string", "format": "date" }
      }
    }
  }
}
```

### KR-081.2 AnalysisResult â€” JSON Schema

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://tarlaanaliz.example/contracts/analysis_result.v1.schema.json",
  "title": "AnalysisResult",
  "type": "object",
  "required": ["schema_version", "result_id", "job_id", "created_at", "status"],
  "properties": {
    "schema_version": { "const": "analysis_result.v1" },
    "result_id": { "type": "string", "pattern": "^[0-9a-fA-F-]{36}$" },
    "job_id": { "type": "string", "pattern": "^[0-9a-fA-F-]{36}$" },
    "findings": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["finding_code", "label"],
        "properties": {
          "finding_code": { "type": "string", "maxLength": 64 },
          "label": { "type": "string", "maxLength": 256 },
          "severity": { "type": "number", "minimum": 0, "maximum": 1 },
          "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
          "area_donum": { "type": "number", "minimum": 0 }
        }
      }
    },
    "summary": {
      "type": "object",
      "required": ["overall_health_index", "notes"],
      "properties": {
        "overall_health_index": { "type": "number", "minimum": 0, "maximum": 1 },
        "notes": { "type": "string", "maxLength": 4000, "description": "YZ analizidir; ilaÃ§lama kararÄ± vermez." }
      }
    }
  }
}
```

**SÃ¼rÃ¼mleme kuralÄ± (SemVer):**
- `v1.x`: geriye uyumlu (backward compatible) eklemeler serbest (optional field eklenebilir)
- `v2.0`: breaking change; `CONTRACTS_VERSION` ve `CONTRACTS_SHA256` zorunlu gÃ¼ncellenir

---

# BÃ–LÃœM 2: SAHA OPERASYONLARI (SOP)

> **Kaynak:** SAHA_OPERASYON_SOP.md

## 2.1 Temel Kavramlar ve Kimlikler

| Kimlik | AÃ§Ä±klama |
|--------|----------|
| FieldID | Sistemde Ã¼retilen benzersiz tarla kimliÄŸi (Tarla ID) |
| MissionID | Bir tarlanÄ±n belirli bir tarih penceresinde planlanan tek gÃ¶rev kimliÄŸi (sistem tarafÄ±ndan Ã¼retilir) |
| BatchID | Yerel istasyona tek seferde yÃ¼klenen veri paketi kimliÄŸi |
| CardID | HafÄ±za kartÄ±na verilen envanter kimliÄŸi (QR/etiket) |
| ParcelRef | Ada/parsel referansÄ± (resmi referans), PII deÄŸildir |

---

## 2.2 GÃ¶rev DosyasÄ± StandardÄ±: KMZ iÃ§inde WPML

**Pratik standart:** KMZ paketinin iÃ§inde WPML ile tanÄ±mlÄ± waypoint/waylines gÃ¶rev verisi bulunur (wpmz/template.kml + wpmz/waylines.wpml).

**GÃ¶rev dosyasÄ± adlandÄ±rma:**
```
{MissionID}_{ParcelRef}_{YYYYMMDD}.kmz
```
(Dosya adÄ±nda PII bulunmaz; MissionID dosya adÄ±nda ve metadata iÃ§inde yer alÄ±r)

**Seed-KMZ Ã¶nerisi:** Pilot 2 ile bir kez "doÄŸru ayarlÄ±" Ã¶rnek gÃ¶rev oluÅŸturulup export edilen KMZ ÅŸablon kabul edilir; sistem sadece sÄ±nÄ±r/parametre alanlarÄ±nÄ± gÃ¼nceller. Bu, sÃ¼rÃ¼m farklarÄ±nda kÄ±rÄ±lmayÄ± azaltÄ±r.

---

## 2.3 Pilot 2 OperatÃ¶r SOP (Saha AdÄ±mlarÄ±)

### 2.3.1 GÃ¶rev Import
1. Kumandaya (RC) SD kart veya dahili depolamaya gÃ¶rev KMZ dosyasÄ±nÄ± kopyala
2. DJI Pilot 2 > Flight Route > Import Route (KMZ/KML) > dosyayÄ± seÃ§
3. GÃ¶rev tÃ¼rÃ¼nÃ¼ onayla ve gÃ¶revi Run/Start ile baÅŸlat

### 2.3.2 GÃ¶rev BitiÅŸi ve Teslim
1. GÃ¶rev tamamlandÄ±ÄŸÄ±nda, karttaki dosya sayÄ±sÄ±/boyutu mantÄ±klÄ± mÄ± kontrol et (aÅŸÄ±rÄ± dÃ¼ÅŸÃ¼kse eksik Ã§ekim ÅŸÃ¼phesidir)
2. Kart, yerel istasyona teslim edilir
3. **Pilot PII gÃ¶rmez; sadece MissionID/ParcelRef seviyesinde gÃ¶rev bilgisi gÃ¶rÃ¼r**

---

## 2.4 Yerel Ä°stasyon: QC + BÃ¼tÃ¼nlÃ¼k + EÅŸleÅŸtirme

**Ã–ncelik eÅŸleÅŸtirme:**
- MissionID â†’ FieldID
- MissionID yoksa, kapsama-izi/footprint - field boundary kesiÅŸimi ile aday eÅŸleÅŸtirme yapÄ±lÄ±r
- DÃ¼ÅŸÃ¼k gÃ¼ven veya Ã§akÄ±ÅŸma varsa manuel inceleme kuyruÄŸuna (gerekirse Expert Portal) alÄ±nÄ±r

**BÃ¼tÃ¼nlÃ¼k:** MANIFEST.json + SHA-256 hash (dosya listesi, boyutlar, zaman damgalarÄ±)

**HÄ±zlÄ± QC (MVP):**
- coverage_ratio
- blur/overexposure bayraklarÄ±
- CRS/extent kontrolÃ¼ (GeoTIFF)
- eksik bant/indeks bayraklarÄ±

**Karantina:** hash uyuÅŸmazlÄ±ÄŸÄ±, malware ÅŸÃ¼phesi veya eÅŸleÅŸtirme hatasÄ± olan paketler quarantine klasÃ¶rÃ¼ne alÄ±nÄ±r, audit log'a yazÄ±lÄ±r.

---

## 2.5 DJI Terra / Pix4Dfields Ã‡Ä±ktÄ± StandardÄ± (GeoTIFF)

**Hedef Ã§Ä±ktÄ±lar:**
- Ortomozaik
- Ä°ndeks haritalarÄ± (NDVI/NDRE vb.)
- Bant kompozitleri

**Format:** CoÄŸrafi referanslÄ± GeoTIFF (CRS bilgisi ve extent doÄŸru olmalÄ±)

> **Not:** DJI Terra Operation Guide v4.2; NDVI ve NDRE gibi vegetation index Ã§Ä±ktÄ±larÄ±nÄ±n desteklendiÄŸini belirtir.

---

## 2.6 YZ Modeli ile Analiz: Ä°zolasyon ve Tek YÃ¶nlÃ¼ AkÄ±ÅŸ

Bu SOP maddesi, operasyonel hatÄ±rlatma niteliÄŸindedir.

- Tek yÃ¶nlÃ¼ akÄ±ÅŸÄ±n **kanonik normatif tanÄ±mÄ±**: **[KR-017]**
- YZ izolasyon â€œÃ§erÃ§evesiâ€: **[KR-070]**
- Saha gÃ¼venlik adÄ±mlarÄ±/checklist: **EK-SOP-SEC**
- EÅŸleÅŸtirme + QC + karantina: **[KR-016]** + **[KR-066]** + **2.4**

---

## 2.7 UÃ§uÅŸ Manifesti: Pratik ve SÃ¼rdÃ¼rÃ¼lebilir YÃ¶ntem

- Manifesti karta "elle yazmak" yerine, manifesti dijital olarak MissionID merkezli tut
- Pilot uygulamasÄ±nda gÃ¶rev check-in/out, yerel istasyonda kart intake taramasÄ±
- **CardID iÃ§in QR etiket kullan:** pilot gÃ¶reve baÅŸlarken CardID + MissionID eÅŸleÅŸtirmesini tek tÄ±kla kaydeder; istasyon teslimde aynÄ± eÅŸleÅŸmeyi doÄŸrular
- DJI Pilot 2 uÃ§uÅŸ kayÄ±tlarÄ± ihtiyaÃ§ halinde kumandadan export edilebilir (Flight Record / log export). Bu kayÄ±tlar, manifestin kanÄ±t katmanÄ±dÄ±r.

---

## 2.8 Kaynaklar

- DJI Cloud API - WPML dokÃ¼mantasyonu: template.kml ve waylines.wpml referanslarÄ± (developer.dji.com, 2025)
- DJI Terra Operation Guide v4.2 (djicdn.com, 2024-10-08)
- DJI Pilot 2 Flight Record / log export kÄ±lavuzu (support.dji.com)

---

## EK-SOP-SEC: Saha GÃ¼venlik Checklist (Pilot + Ä°stasyon)

Bu ek, saha operasyonunda veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ ve zincir izlenebilirliÄŸini (chain-of-custody) korumak iÃ§in minimum kontrol listesidir.

### Pilot Checklist
- [ ] GÃ¶rev dosyasÄ± (KMZ) yalnÄ±zca kanonik formatta olmalÄ± ve MissionID/ParcelRef/Date alanlarÄ± doÄŸrulanmalÄ±
- [ ] UÃ§uÅŸ sonrasÄ± SD kartta beklenmeyen dosya/klasÃ¶r var mÄ± hÄ±zlÄ± kontrol (allowlist dÄ±ÅŸÄ± ise istasyona bildirim)
- [ ] SD kart, mÃ¼hÃ¼r/etiket ile istasyona teslim; teslim anÄ±nda CardID/MissionID eÅŸleÅŸtirmesi yapÄ±lÄ±r

### Ä°stasyon (Kiosk/Karantina) Checklist
- [ ] CardID + MissionID + BatchID kaydÄ± aÃ§Ä±lÄ±r; giriÅŸ zamanÄ± ve teslim alan kiÅŸi loglanÄ±r
- [ ] Dosya allowlist/MIME/size kontrolÃ¼ yapÄ±lÄ±r; uygunsuz iÃ§erik karantinaya alÄ±nÄ±r
- [ ] SHA-256 manifest Ã¼retilir veya doÄŸrulanÄ±r; hash uyuÅŸmazlÄ±ÄŸÄ± varsa karantina + alarm
- [ ] AV taramasÄ± (EICAR dahil test prosedÃ¼rÃ¼) geÃ§meden hiÃ§bir dosya iÅŸlenmez
- [ ] **Karantina PC internetsiz**; dÄ±ÅŸ medya steril prosedÃ¼rÃ¼ uygulanÄ±r; Ã§Ä±ktÄ±lar imzalÄ± paket olarak aktarÄ±lÄ±r
- [ ] Upload/queue sonrasÄ± worker sonucu geldiÄŸinde MissionID Ã¼zerinden sonuÃ§-tarla eÅŸleÅŸmesi doÄŸrulanÄ±r
- [ ] TÃ¼m adÄ±mlar audit log'a yazÄ±lÄ±r; gÃ¼nlÃ¼k karantina raporu Ã¼retilir

### Minimum KanÄ±t (Denetim Ä°Ã§in)
- Manifest dosyasÄ± + hash raporu
- AV tarama raporu
- Karantina kayÄ±tlarÄ± (varsa)
- MissionID tabanlÄ± ingest/iÅŸleme log zinciri

---

# BÃ–LÃœM 3: GÃ–ZLEMLENEBÄ°LÄ°RLÄ°K (OBSERVABILITY) STANDARDI

## 3.1 Log ÅžemasÄ± + Correlation ID

Bu standart, **istasyon offline** akÄ±ÅŸlarÄ± dahil uÃ§tan uca iz sÃ¼rmek (trace) ve denetim (audit) iÃ§in **zorunludur**.
PII minimizasyonu gereÄŸi loglar **PII iÃ§ermez**; `actor_id_hash` gibi tek-yÃ¶nlÃ¼ kimlikler kullanÄ±lÄ±r.

### Zorunlu Alanlar (JSONL â€” her satÄ±r 1 olay)

```json
{
  "ts": "2026-01-27T10:15:30.123+03:00",
  "level": "INFO",
  "service": "station_kiosk | backend | ai_worker | web_pwa",
  "env": "prod | stage | dev",
  "app_version": "semver",
  "event_type": "INGEST | AUTH | RBAC | PRICING | JOB | RESULT | SECURITY | SYSTEM",
  "event_action": "CREATE | VALIDATE | UPLOAD | QUEUE | START | FINISH | DENY | UPDATE",
  "outcome": "SUCCESS | FAIL",
  "correlation_id": "corr_8f3a1e0c6f0d4e3d",
  "trace_id": "w3c_trace_id_optional",
  "span_id": "w3c_span_id_optional",
  "actor_type": "farmer | pilot | il_operator | admin | system",
  "actor_id_hash": "hash/opaque-id",
  "device_id": "kiosk_device_id",
  "field_id": "FieldID",
  "mission_id": "MissionID",
  "batch_id": "BatchID",
  "card_id": "CardID",
  "station_ingest_run_id": "SIR-...",
  "job_id": "uuid",
  "http": {"method": "POST", "path": "/api/v1/ingest", "status": 201},
  "latency_ms": 123,
  "error": {"code": "HASH_MISMATCH", "message": "short-safe"},
  "pii": false
}
```

**Kurallar:**
- `correlation_id` **her zaman zorunlu** ve tÃ¼m servislerde aynen taÅŸÄ±nÄ±r
- `error.message` max 120 karakter, **PII yok**, stacktrace ayrÄ± (sadece gÃ¼venli ortamda)

### Correlation ID Ãœretimi ve TaÅŸÄ±nmasÄ± (Propagation)

- **Ãœretim noktasÄ±:** `station_kiosk` ingest baÅŸlatÄ±nca Ã¼retir: `corr_<16-32 hex>`
- **HTTP header:** `X-Correlation-Id: <correlation_id>` zorunlu
- **W3C Trace Context:** MÃ¼mkÃ¼nse `traceparent` kullanÄ±lÄ±r; yoksa sadece correlation id yeterlidir
- **Offline paketleme:** `manifest.json` iÃ§ine `correlation_id` yazÄ±lÄ±r ve paket imzasÄ±na dahil edilir

### Audit Log (WORM) â€” Minimum Olay Seti

WORM/immutable audit olaylarÄ±:
- `PRICING.UPDATE` (admin) â€” eski/yeni snapshot hash + kim yaptÄ±
- `RBAC.ROLE_ASSIGN/ROLE_REVOKE`
- `EXPERT.ASSIGN/UNASSIGN`
- `INGEST.QUARANTINE/RELEASE`
- `JOB.CANCEL`
- `SECURITY.DENY` (mTLS fail, allowlist fail, signature fail)
- `RESULT.SIGNATURE_FAIL`

---

# BÃ–LÃœM 4: THREAT MODEL ONE-PAGER

| VarlÄ±k (Asset) | Tehdit | SaldÄ±rÄ± YÃ¼zeyi | Kontrol / Mitigasyon | Tespit / KanÄ±t |
|----------------|--------|----------------|----------------------|----------------|
| SD Kart | ZararlÄ± dosya / trojan | Pilotun karta dosya eklemesi | Allowlist (uzantÄ±/MIME), boyut limit, AV taramasÄ±, karantina | `INGEST.QUARANTINE` audit + AV raporu hash'li |
| SD Kart | Sahte/eksik iÃ§erik | Eksik set, sonradan ekleme | SHA-256 manifest + imza doÄŸrulama | `HASH_MISMATCH` olayÄ± + immutable log |
| Quarantine PC (air-gapped) | Offline PC enfeksiyonu | USB/SD Ã¼zerinden bulaÅŸ | Tek yÃ¶n veri akÄ±ÅŸÄ±, OS hardening, sadece allowlist device | AV imzalarÄ± + boot attestation log (varsa) |
| EdgeKiosk cihaz kimliÄŸi | Cihaz taklidi | mTLS sertifika Ã§alÄ±nmasÄ± | Cihaz kayÄ±t + mTLS + sertifika rotasyonu + iptal listesi | `SECURITY.DENY` + sertifika fingerprint |
| Backend API | Yetki aÅŸÄ±mÄ± | Endpoint suistimali | RBAC, policy testleri, deny-by-default | 403 negatif test kanÄ±tÄ± + audit |
| Pricing | Fiyat geÃ§miÅŸi bozulmasÄ± | Admin gÃ¼ncellemesi | PriceBook snapshot + immutable audit | `PRICING.UPDATE` audit + snapshot sha256 |
| Expert Portal | PII sÄ±zÄ±ntÄ±sÄ± | Panel ekranlarÄ± | PII yok; sadece FieldID/KPI; maskeleme | Otomatik PII testleri + redaction raporu |
| Model aÄŸÄ±rlÄ±klarÄ± | Model Ã§alÄ±nmasÄ± | Worker disk eriÅŸimi | AyrÄ± aÄŸ segmenti, minimal IAM, watermarking | Anomali tespiti + eriÅŸim loglarÄ± |
| Model zehirleme | KÃ¶tÃ¼ veri giriÅŸi | Sahte etiket/uzman | Expert review + provenance + hash zinciri | Review trail + dataset manifest |
| Job Queue | Replay / duplicate job | Idempotency eksikliÄŸi | `idempotency_key` + dedupe | `JOB.DEDUPE` log + metrik |
| SonuÃ§ katmanlarÄ± | ManipÃ¼le sonuÃ§ | SonuÃ§ dosyasÄ± deÄŸiÅŸtirme | SonuÃ§ artifact sha256 + imzalÄ± paket | `RESULT.SIGNATURE_FAIL` |
| Mobil/Web | Hesap ele geÃ§irme | PIN brute force | Rate limit, lockout, cihaz bazlÄ± throttle | `AUTH.DENY` metrik + audit |

---

### Repository Ä°liÅŸkileri

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tarlaanaliz-contracts (Source of Truth)                  â”‚
â”‚  - API schemas, OpenAPI specs, enum definitions           â”‚
â”‚  - Contract validation + breaking change detection        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ (git submodule)           â†“              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Platform   â”‚         â”‚   Worker   â”‚   â”‚     Edge    â”‚
    â”‚  (Backend +  â”‚â†â”€RMQâ”€â†’â”‚  (AI/ML)   â”‚   â”‚   (Kiosk)   â”‚
    â”‚   Frontend)  â”‚         â”‚            â”‚   â”‚  (Offline)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘                                            â†“
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HTTPS + mTLS â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

# BÃ–LÃœM 5: GÃœVENLÄ°K VE DENETLENEBÄ°LÄ°RLÄ°K â€” NAVÄ°GASYON

Bu bÃ¶lÃ¼m, gÃ¼venlik kurallarÄ±nÄ± **tekrar etmek** iÃ§in deÄŸil; SSOT iÃ§inde â€œtek bakÄ±ÅŸtaâ€ doÄŸru yerlere yÃ¶nlendirmek iÃ§in vardÄ±r.

- **Kimlik + brute-force korumalarÄ±:** [KR-050] + (testler: SC-SEC-01/02)
- **RBAC ve PII ayrÄ±mÄ± (KVKK):** [KR-063] + [KR-066]
- **YZ izolasyonu / one-way akÄ±ÅŸ:** [KR-017] (stub: [KR-070], kaldÄ±rÄ±ldÄ±: [KR-071])
- **Radyometrik kalibrasyon hard gate:** [KR-018] (alias: [KR-082])
- **SDLC gÃ¼venlik kapÄ±larÄ± + kabul kriterleri:** [KR-040]â€“[KR-043]
- **Audit/WORM olay ÅŸemasÄ± + correlation_id:** BÃ–LÃœM 3
- **Threat model:** BÃ–LÃœM 4
- **Saha gÃ¼venlik checklist:** EK-SOP-SEC


# BÃ–LÃœM 6: TEST SENARYOLARI

## 6.1 Expert Portal Tests

| Senaryo | Test AdÄ±mÄ± | Beklenen SonuÃ§ |
|---------|------------|----------------|
| SC-EXP-01 | Low confidence (0.68 < 0.75) | Expert review oluÅŸturulur + SMS gÃ¶nderilir |
| SC-EXP-02 | Uzman login | Dashboard'da pending count gÃ¶rÃ¼nÃ¼r |
| SC-EXP-03 | Ä°nceleme aÃ§ | RGB/NIR gÃ¶rÃ¼ntÃ¼ler + Model tahmini |
| SC-EXP-04 | Verdict submit | Feedback AI Worker'a gÃ¶nderilir |
| SC-EXP-05 | SLA aÅŸÄ±mÄ± (4s+) | Yedek uzman'a escalation |

## 6.2 GÃ¼venlik Tests

| Senaryo | Test | SonuÃ§ |
|---------|------|-------|
| SC-SEC-01 | Rate limit 61 req/min | HTTP 429 |
| SC-SEC-02 | Brute force 16 fail | 30 min lock |
| SC-SEC-03 | Model extraction 50+ req/day | Anomaly > 0.8 â†’ Throttle |
| SC-SEC-04 | SQL injection WAF | HTTP 403 |
| SC-SEC-05 | Watermark verify | Match > 0.9 â†’ Forensic |

---